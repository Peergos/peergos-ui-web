"use strict";
var node_fs_stats_1 = require('../core/node_fs_stats');
var path = require('path');
var FileIndex = (function () {
    function FileIndex() {
        this._index = {};
        this.addPath('/', new DirInode());
    }
    FileIndex.prototype._split_path = function (p) {
        var dirpath = path.dirname(p);
        var itemname = p.substr(dirpath.length + (dirpath === "/" ? 0 : 1));
        return [dirpath, itemname];
    };
    FileIndex.prototype.fileIterator = function (cb) {
        for (var path in this._index) {
            var dir = this._index[path];
            var files = dir.getListing();
            for (var i = 0; i < files.length; i++) {
                var item = dir.getItem(files[i]);
                if (isFileInode(item)) {
                    cb(item.getData());
                }
            }
        }
    };
    FileIndex.prototype.addPath = function (path, inode) {
        if (inode == null) {
            throw new Error('Inode must be specified');
        }
        if (path[0] !== '/') {
            throw new Error('Path must be absolute, got: ' + path);
        }
        if (this._index.hasOwnProperty(path)) {
            return this._index[path] === inode;
        }
        var splitPath = this._split_path(path);
        var dirpath = splitPath[0];
        var itemname = splitPath[1];
        var parent = this._index[dirpath];
        if (parent === undefined && path !== '/') {
            parent = new DirInode();
            if (!this.addPath(dirpath, parent)) {
                return false;
            }
        }
        if (path !== '/') {
            if (!parent.addItem(itemname, inode)) {
                return false;
            }
        }
        if (isDirInode(inode)) {
            this._index[path] = inode;
        }
        return true;
    };
    FileIndex.prototype.addPathFast = function (path, inode) {
        var itemNameMark = path.lastIndexOf('/');
        var parentPath = itemNameMark == 0 ? "/" : path.substring(0, itemNameMark);
        var itemName = path.substring(itemNameMark + 1);
        var parent = this._index[parentPath];
        if (parent === undefined) {
            parent = new DirInode();
            this.addPathFast(parentPath, parent);
        }
        if (!parent.addItem(itemName, inode)) {
            return false;
        }
        if (inode.isDir()) {
            this._index[path] = inode;
        }
        return true;
    };
    FileIndex.prototype.removePath = function (path) {
        var splitPath = this._split_path(path);
        var dirpath = splitPath[0];
        var itemname = splitPath[1];
        var parent = this._index[dirpath];
        if (parent === undefined) {
            return null;
        }
        var inode = parent.remItem(itemname);
        if (inode === null) {
            return null;
        }
        if (isDirInode(inode)) {
            var children = inode.getListing();
            for (var i = 0; i < children.length; i++) {
                this.removePath(path + '/' + children[i]);
            }
            if (path !== '/') {
                delete this._index[path];
            }
        }
        return inode;
    };
    FileIndex.prototype.ls = function (path) {
        var item = this._index[path];
        if (item === undefined) {
            return null;
        }
        return item.getListing();
    };
    FileIndex.prototype.getInode = function (path) {
        var splitPath = this._split_path(path);
        var dirpath = splitPath[0];
        var itemname = splitPath[1];
        var parent = this._index[dirpath];
        if (parent === undefined) {
            return null;
        }
        if (dirpath === path) {
            return parent;
        }
        return parent.getItem(itemname);
    };
    FileIndex.fromListing = function (listing) {
        var idx = new FileIndex();
        var rootInode = new DirInode();
        idx._index['/'] = rootInode;
        var queue = [['', listing, rootInode]];
        while (queue.length > 0) {
            var inode;
            var next = queue.pop();
            var pwd = next[0];
            var tree = next[1];
            var parent = next[2];
            for (var node in tree) {
                var children = tree[node];
                var name = "" + pwd + "/" + node;
                if (children != null) {
                    idx._index[name] = inode = new DirInode();
                    queue.push([name, children, inode]);
                }
                else {
                    inode = new FileInode(new node_fs_stats_1["default"](node_fs_stats_1.FileType.FILE, -1, 0x16D));
                }
                if (parent != null) {
                    parent._ls[node] = inode;
                }
            }
        }
        return idx;
    };
    return FileIndex;
}());
exports.FileIndex = FileIndex;
var FileInode = (function () {
    function FileInode(data) {
        this.data = data;
    }
    FileInode.prototype.isFile = function () { return true; };
    FileInode.prototype.isDir = function () { return false; };
    FileInode.prototype.getData = function () { return this.data; };
    FileInode.prototype.setData = function (data) { this.data = data; };
    return FileInode;
}());
exports.FileInode = FileInode;
var DirInode = (function () {
    function DirInode(data) {
        if (data === void 0) { data = null; }
        this.data = data;
        this._ls = {};
    }
    DirInode.prototype.isFile = function () {
        return false;
    };
    DirInode.prototype.isDir = function () {
        return true;
    };
    DirInode.prototype.getData = function () { return this.data; };
    DirInode.prototype.getStats = function () {
        return new node_fs_stats_1["default"](node_fs_stats_1.FileType.DIRECTORY, 4096, 0x16D);
    };
    DirInode.prototype.getListing = function () {
        return Object.keys(this._ls);
    };
    DirInode.prototype.getItem = function (p) {
        var _ref;
        return (_ref = this._ls[p]) != null ? _ref : null;
    };
    DirInode.prototype.addItem = function (p, inode) {
        if (p in this._ls) {
            return false;
        }
        this._ls[p] = inode;
        return true;
    };
    DirInode.prototype.remItem = function (p) {
        var item = this._ls[p];
        if (item === undefined) {
            return null;
        }
        delete this._ls[p];
        return item;
    };
    return DirInode;
}());
exports.DirInode = DirInode;
function isFileInode(inode) {
    return inode && inode.isFile();
}
exports.isFileInode = isFileInode;
function isDirInode(inode) {
    return inode && inode.isDir();
}
exports.isDirInode = isDirInode;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZmlsZV9pbmRleC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9nZW5lcmljL2ZpbGVfaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDhCQUF5Qyx1QkFBdUIsQ0FBQyxDQUFBO0FBQ2pFLElBQU8sSUFBSSxXQUFXLE1BQU0sQ0FBQyxDQUFDO0FBUzlCO0lBT0U7UUFHRSxJQUFJLENBQUMsTUFBTSxHQUFHLEVBQUUsQ0FBQztRQUVqQixJQUFJLENBQUMsT0FBTyxDQUFDLEdBQUcsRUFBRSxJQUFJLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUtPLCtCQUFXLEdBQW5CLFVBQW9CLENBQVM7UUFDM0IsSUFBSSxPQUFPLEdBQUcsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM5QixJQUFJLFFBQVEsR0FBRyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxPQUFPLEtBQUssR0FBRyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3BFLE1BQU0sQ0FBQyxDQUFDLE9BQU8sRUFBRSxRQUFRLENBQUMsQ0FBQztJQUM3QixDQUFDO0lBS00sZ0NBQVksR0FBbkIsVUFBdUIsRUFBcUI7UUFDMUMsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7WUFDN0IsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUM1QixJQUFJLEtBQUssR0FBRyxHQUFHLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDN0IsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7Z0JBQ3RDLElBQUksSUFBSSxHQUFHLEdBQUcsQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2pDLEVBQUUsQ0FBQyxDQUFDLFdBQVcsQ0FBSSxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3pCLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUMsQ0FBQztnQkFDckIsQ0FBQztZQUNILENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQWNNLDJCQUFPLEdBQWQsVUFBZSxJQUFZLEVBQUUsS0FBWTtRQUN2QyxFQUFFLENBQUMsQ0FBQyxLQUFLLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNsQixNQUFNLElBQUksS0FBSyxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDN0MsQ0FBQztRQUNELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLEdBQUcsSUFBSSxDQUFDLENBQUM7UUFDekQsQ0FBQztRQUdELEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNyQyxNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxLQUFLLENBQUM7UUFDckMsQ0FBQztRQUVELElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsSUFBSSxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNCLElBQUksUUFBUSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUU1QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLElBQUksSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFFekMsTUFBTSxHQUFHLElBQUksUUFBUSxFQUFLLENBQUM7WUFDM0IsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ25DLE1BQU0sQ0FBQyxLQUFLLENBQUM7WUFDZixDQUFDO1FBQ0gsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQ2pCLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNyQyxNQUFNLENBQUMsS0FBSyxDQUFDO1lBQ2YsQ0FBQztRQUNILENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxVQUFVLENBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQzVCLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQWVNLCtCQUFXLEdBQWxCLFVBQW1CLElBQVksRUFBRSxLQUFZO1FBRTNDLElBQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDM0MsSUFBTSxVQUFVLEdBQUcsWUFBWSxJQUFJLENBQUMsR0FBRyxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7UUFDN0UsSUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLEdBQUMsQ0FBQyxDQUFDLENBQUM7UUFHaEQsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUNyQyxFQUFFLENBQUMsQ0FBQyxNQUFNLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUV6QixNQUFNLEdBQUcsSUFBSSxRQUFRLEVBQUssQ0FBQztZQUMzQixJQUFJLENBQUMsV0FBVyxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsQ0FBQztRQUN2QyxDQUFDO1FBRUQsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckMsTUFBTSxDQUFDLEtBQUssQ0FBQztRQUNmLENBQUM7UUFHRCxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQWlCLEtBQUssQ0FBQztRQUMxQyxDQUFDO1FBQ0QsTUFBTSxDQUFDLElBQUksQ0FBQztJQUNkLENBQUM7SUFPTSw4QkFBVSxHQUFqQixVQUFrQixJQUFZO1FBQzVCLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDdkMsSUFBSSxPQUFPLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQzNCLElBQUksUUFBUSxHQUFHLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUc1QixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxDQUFDO1FBQ2xDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sS0FBSyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsSUFBSSxLQUFLLEdBQUcsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUNyQyxFQUFFLENBQUMsQ0FBQyxLQUFLLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELEVBQUUsQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBQ2xDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO2dCQUN6QyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDNUMsQ0FBQztZQUdELEVBQUUsQ0FBQyxDQUFDLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQyxDQUFDO2dCQUNqQixPQUFPLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0IsQ0FBQztRQUNILENBQUM7UUFDRCxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQU9NLHNCQUFFLEdBQVQsVUFBVSxJQUFZO1FBQ3BCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0IsRUFBRSxDQUFDLENBQUMsSUFBSSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDdkIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNkLENBQUM7UUFDRCxNQUFNLENBQUMsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO0lBQzNCLENBQUM7SUFRTSw0QkFBUSxHQUFmLFVBQWdCLElBQVk7UUFDMUIsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUN2QyxJQUFJLE9BQU8sR0FBRyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDM0IsSUFBSSxRQUFRLEdBQUcsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBRTVCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7UUFDbEMsRUFBRSxDQUFDLENBQUMsTUFBTSxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUM7WUFDekIsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxPQUFPLEtBQUssSUFBSSxDQUFDLENBQUMsQ0FBQztZQUNyQixNQUFNLENBQUMsTUFBTSxDQUFDO1FBQ2hCLENBQUM7UUFDRCxNQUFNLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBT2EscUJBQVcsR0FBekIsVUFBNkIsT0FBTztRQUNsQyxJQUFJLEdBQUcsR0FBRyxJQUFJLFNBQVMsRUFBSyxDQUFDO1FBRTdCLElBQUksU0FBUyxHQUFHLElBQUksUUFBUSxFQUFLLENBQUM7UUFDbEMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsR0FBRyxTQUFTLENBQUM7UUFDNUIsSUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDLEVBQUUsRUFBRSxPQUFPLEVBQUUsU0FBUyxDQUFDLENBQUMsQ0FBQztRQUN2QyxPQUFPLEtBQUssQ0FBQyxNQUFNLEdBQUcsQ0FBQyxFQUFFLENBQUM7WUFDeEIsSUFBSSxLQUFLLENBQUM7WUFDVixJQUFJLElBQUksR0FBRyxLQUFLLENBQUMsR0FBRyxFQUFFLENBQUM7WUFDdkIsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xCLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDckIsR0FBRyxDQUFDLENBQUMsSUFBSSxJQUFJLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztnQkFDdEIsSUFBSSxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUMxQixJQUFJLElBQUksR0FBRyxFQUFFLEdBQUcsR0FBRyxHQUFHLEdBQUcsR0FBRyxJQUFJLENBQUM7Z0JBQ2pDLEVBQUUsQ0FBQyxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsQ0FBQyxDQUFDO29CQUNyQixHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLEtBQUssR0FBRyxJQUFJLFFBQVEsRUFBSyxDQUFDO29CQUM3QyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsSUFBSSxFQUFFLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDO2dCQUN0QyxDQUFDO2dCQUFDLElBQUksQ0FBQyxDQUFDO29CQUVOLEtBQUssR0FBRyxJQUFJLFNBQVMsQ0FBUSxJQUFJLDBCQUFLLENBQUMsd0JBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQztnQkFDcEUsQ0FBQztnQkFDRCxFQUFFLENBQUMsQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztvQkFDbkIsTUFBTSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxLQUFLLENBQUM7Z0JBQzNCLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUNELE1BQU0sQ0FBQyxHQUFHLENBQUM7SUFDYixDQUFDO0lBQ0gsZ0JBQUM7QUFBRCxDQUFDLEFBeE9ELElBd09DO0FBeE9ZLGlCQUFTLFlBd09yQixDQUFBO0FBZ0JEO0lBQ0UsbUJBQW9CLElBQU87UUFBUCxTQUFJLEdBQUosSUFBSSxDQUFHO0lBQUksQ0FBQztJQUN6QiwwQkFBTSxHQUFiLGNBQTJCLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ2xDLHlCQUFLLEdBQVosY0FBMEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7SUFDbEMsMkJBQU8sR0FBZCxjQUFzQixNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDbEMsMkJBQU8sR0FBZCxVQUFlLElBQU8sSUFBVSxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDckQsZ0JBQUM7QUFBRCxDQUFDLEFBTkQsSUFNQztBQU5ZLGlCQUFTLFlBTXJCLENBQUE7QUFLRDtJQUtFLGtCQUFvQixJQUFjO1FBQXRCLG9CQUFzQixHQUF0QixXQUFzQjtRQUFkLFNBQUksR0FBSixJQUFJLENBQVU7UUFKMUIsUUFBRyxHQUE0QixFQUFFLENBQUM7SUFJTCxDQUFDO0lBQy9CLHlCQUFNLEdBQWI7UUFDRSxNQUFNLENBQUMsS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUNNLHdCQUFLLEdBQVo7UUFDRSxNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNNLDBCQUFPLEdBQWQsY0FBc0IsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBUWxDLDJCQUFRLEdBQWY7UUFDRSxNQUFNLENBQUMsSUFBSSwwQkFBSyxDQUFDLHdCQUFRLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNwRCxDQUFDO0lBTU0sNkJBQVUsR0FBakI7UUFDRSxNQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQU1NLDBCQUFPLEdBQWQsVUFBZSxDQUFTO1FBQ3RCLElBQUksSUFBSSxDQUFDO1FBQ1QsTUFBTSxDQUFDLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNwRCxDQUFDO0lBU00sMEJBQU8sR0FBZCxVQUFlLENBQVMsRUFBRSxLQUFZO1FBQ3BDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztZQUNsQixNQUFNLENBQUMsS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUNELElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDO1FBQ3BCLE1BQU0sQ0FBQyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBT00sMEJBQU8sR0FBZCxVQUFlLENBQVM7UUFDdEIsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN2QixFQUFFLENBQUMsQ0FBQyxJQUFJLEtBQUssU0FBUyxDQUFDLENBQUMsQ0FBQztZQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUNELE9BQU8sSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNuQixNQUFNLENBQUMsSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUNILGVBQUM7QUFBRCxDQUFDLEFBckVELElBcUVDO0FBckVZLGdCQUFRLFdBcUVwQixDQUFBO0FBRUQscUJBQStCLEtBQVk7SUFDekMsTUFBTSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUMsTUFBTSxFQUFFLENBQUM7QUFDakMsQ0FBQztBQUZlLG1CQUFXLGNBRTFCLENBQUE7QUFFRCxvQkFBOEIsS0FBWTtJQUN4QyxNQUFNLENBQUMsS0FBSyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUUsQ0FBQztBQUNoQyxDQUFDO0FBRmUsa0JBQVUsYUFFekIsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7ZGVmYXVsdCBhcyBTdGF0cywgRmlsZVR5cGV9IGZyb20gJy4uL2NvcmUvbm9kZV9mc19zdGF0cyc7XHJcbmltcG9ydCBwYXRoID0gcmVxdWlyZSgncGF0aCcpO1xyXG5cclxuLyoqXHJcbiAqIEEgc2ltcGxlIGNsYXNzIGZvciBzdG9yaW5nIGEgZmlsZXN5c3RlbSBpbmRleC4gQXNzdW1lcyB0aGF0IGFsbCBwYXRocyBwYXNzZWRcclxuICogdG8gaXQgYXJlICphYnNvbHV0ZSogcGF0aHMuXHJcbiAqXHJcbiAqIENhbiBiZSB1c2VkIGFzIGEgcGFydGlhbCBvciBhIGZ1bGwgaW5kZXgsIGFsdGhvdWdoIGNhcmUgbXVzdCBiZSB0YWtlbiBpZiB1c2VkXHJcbiAqIGZvciB0aGUgZm9ybWVyIHB1cnBvc2UsIGVzcGVjaWFsbHkgd2hlbiBkaXJlY3RvcmllcyBhcmUgY29uY2VybmVkLlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEZpbGVJbmRleDxUPiB7XHJcbiAgLy8gTWFwcyBkaXJlY3RvcnkgcGF0aHMgdG8gZGlyZWN0b3J5IGlub2Rlcywgd2hpY2ggY29udGFpbiBmaWxlcy5cclxuICBwcml2YXRlIF9pbmRleDoge1twYXRoOiBzdHJpbmddOiBEaXJJbm9kZTxUPn1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29uc3RydWN0cyBhIG5ldyBGaWxlSW5kZXguXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICAvLyBfaW5kZXggaXMgYSBzaW5nbGUtbGV2ZWwga2V5LHZhbHVlIHN0b3JlIHRoYXQgbWFwcyAqZGlyZWN0b3J5KiBwYXRocyB0b1xyXG4gICAgLy8gRGlySW5vZGVzLiBGaWxlIGluZm9ybWF0aW9uIGlzIG9ubHkgY29udGFpbmVkIGluIERpcklub2RlcyB0aGVtc2VsdmVzLlxyXG4gICAgdGhpcy5faW5kZXggPSB7fTtcclxuICAgIC8vIENyZWF0ZSB0aGUgcm9vdCBkaXJlY3RvcnkuXHJcbiAgICB0aGlzLmFkZFBhdGgoJy8nLCBuZXcgRGlySW5vZGUoKSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBTcGxpdCBpbnRvIGEgKGRpcmVjdG9yeSBwYXRoLCBpdGVtIG5hbWUpIHBhaXJcclxuICAgKi9cclxuICBwcml2YXRlIF9zcGxpdF9wYXRoKHA6IHN0cmluZyk6IHN0cmluZ1tdIHtcclxuICAgIHZhciBkaXJwYXRoID0gcGF0aC5kaXJuYW1lKHApO1xyXG4gICAgdmFyIGl0ZW1uYW1lID0gcC5zdWJzdHIoZGlycGF0aC5sZW5ndGggKyAoZGlycGF0aCA9PT0gXCIvXCIgPyAwIDogMSkpO1xyXG4gICAgcmV0dXJuIFtkaXJwYXRoLCBpdGVtbmFtZV07XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBSdW5zIHRoZSBnaXZlbiBmdW5jdGlvbiBvdmVyIGFsbCBmaWxlcyBpbiB0aGUgaW5kZXguXHJcbiAgICovXHJcbiAgcHVibGljIGZpbGVJdGVyYXRvcjxUPihjYjogKGZpbGU6IFQpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIGZvciAodmFyIHBhdGggaW4gdGhpcy5faW5kZXgpIHtcclxuICAgICAgdmFyIGRpciA9IHRoaXMuX2luZGV4W3BhdGhdO1xyXG4gICAgICB2YXIgZmlsZXMgPSBkaXIuZ2V0TGlzdGluZygpO1xyXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGZpbGVzLmxlbmd0aDsgaSsrKSB7XHJcbiAgICAgICAgdmFyIGl0ZW0gPSBkaXIuZ2V0SXRlbShmaWxlc1tpXSk7XHJcbiAgICAgICAgaWYgKGlzRmlsZUlub2RlPFQ+KGl0ZW0pKSB7XHJcbiAgICAgICAgICBjYihpdGVtLmdldERhdGEoKSk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBBZGRzIHRoZSBnaXZlbiBhYnNvbHV0ZSBwYXRoIHRvIHRoZSBpbmRleCBpZiBpdCBpcyBub3QgYWxyZWFkeSBpbiB0aGUgaW5kZXguXHJcbiAgICogQ3JlYXRlcyBhbnkgbmVlZGVkIHBhcmVudCBkaXJlY3Rvcmllcy5cclxuICAgKiBAcGFyYW0gW1N0cmluZ10gcGF0aCBUaGUgcGF0aCB0byBhZGQgdG8gdGhlIGluZGV4LlxyXG4gICAqIEBwYXJhbSBbQnJvd3NlckZTLkZpbGVJbm9kZSB8IEJyb3dzZXJGUy5EaXJJbm9kZV0gaW5vZGUgVGhlIGlub2RlIGZvciB0aGVcclxuICAgKiAgIHBhdGggdG8gYWRkLlxyXG4gICAqIEByZXR1cm4gW0Jvb2xlYW5dICdUcnVlJyBpZiBpdCB3YXMgYWRkZWQgb3IgYWxyZWFkeSBleGlzdHMsICdmYWxzZScgaWYgdGhlcmVcclxuICAgKiAgIHdhcyBhbiBpc3N1ZSBhZGRpbmcgaXQgKGUuZy4gaXRlbSBpbiBwYXRoIGlzIGEgZmlsZSwgaXRlbSBleGlzdHMgYnV0IGlzXHJcbiAgICogICBkaWZmZXJlbnQpLlxyXG4gICAqIEB0b2RvIElmIGFkZGluZyBmYWlscyBhbmQgaW1wbGljaXRseSBjcmVhdGVzIGRpcmVjdG9yaWVzLCB3ZSBkbyBub3QgY2xlYW4gdXBcclxuICAgKiAgIHRoZSBuZXcgZW1wdHkgZGlyZWN0b3JpZXMuXHJcbiAgICovXHJcbiAgcHVibGljIGFkZFBhdGgocGF0aDogc3RyaW5nLCBpbm9kZTogSW5vZGUpOiBib29sZWFuIHtcclxuICAgIGlmIChpbm9kZSA9PSBudWxsKSB7XHJcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW5vZGUgbXVzdCBiZSBzcGVjaWZpZWQnKTtcclxuICAgIH1cclxuICAgIGlmIChwYXRoWzBdICE9PSAnLycpIHtcclxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdQYXRoIG11c3QgYmUgYWJzb2x1dGUsIGdvdDogJyArIHBhdGgpO1xyXG4gICAgfVxyXG5cclxuICAgIC8vIENoZWNrIGlmIGl0IGFscmVhZHkgZXhpc3RzLlxyXG4gICAgaWYgKHRoaXMuX2luZGV4Lmhhc093blByb3BlcnR5KHBhdGgpKSB7XHJcbiAgICAgIHJldHVybiB0aGlzLl9pbmRleFtwYXRoXSA9PT0gaW5vZGU7XHJcbiAgICB9XHJcblxyXG4gICAgdmFyIHNwbGl0UGF0aCA9IHRoaXMuX3NwbGl0X3BhdGgocGF0aCk7XHJcbiAgICB2YXIgZGlycGF0aCA9IHNwbGl0UGF0aFswXTtcclxuICAgIHZhciBpdGVtbmFtZSA9IHNwbGl0UGF0aFsxXTtcclxuICAgIC8vIFRyeSB0byBhZGQgdG8gaXRzIHBhcmVudCBkaXJlY3RvcnkgZmlyc3QuXHJcbiAgICB2YXIgcGFyZW50ID0gdGhpcy5faW5kZXhbZGlycGF0aF07XHJcbiAgICBpZiAocGFyZW50ID09PSB1bmRlZmluZWQgJiYgcGF0aCAhPT0gJy8nKSB7XHJcbiAgICAgIC8vIENyZWF0ZSBwYXJlbnQuXHJcbiAgICAgIHBhcmVudCA9IG5ldyBEaXJJbm9kZTxUPigpO1xyXG4gICAgICBpZiAoIXRoaXMuYWRkUGF0aChkaXJwYXRoLCBwYXJlbnQpKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyBBZGQgbXlzZWxmIHRvIG15IHBhcmVudC5cclxuICAgIGlmIChwYXRoICE9PSAnLycpIHtcclxuICAgICAgaWYgKCFwYXJlbnQuYWRkSXRlbShpdGVtbmFtZSwgaW5vZGUpKSB7XHJcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgICAvLyBJZiBJJ20gYSBkaXJlY3RvcnksIGFkZCBteXNlbGYgdG8gdGhlIGluZGV4LlxyXG4gICAgaWYgKGlzRGlySW5vZGU8VD4oaW5vZGUpKSB7XHJcbiAgICAgIHRoaXMuX2luZGV4W3BhdGhdID0gaW5vZGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFkZHMgdGhlIGdpdmVuIGFic29sdXRlIHBhdGggdG8gdGhlIGluZGV4IGlmIGl0IGlzIG5vdCBhbHJlYWR5IGluIHRoZSBpbmRleC5cclxuICAgKiBUaGUgcGF0aCBpcyBhZGRlZCB3aXRob3V0IHNwZWNpYWwgdHJlYXRtZW50IChubyBqb2luaW5nIG9mIGFkamFjZW50IHNlcGFyYXRvcnMsIGV0YykuXHJcbiAgICogQ3JlYXRlcyBhbnkgbmVlZGVkIHBhcmVudCBkaXJlY3Rvcmllcy5cclxuICAgKiBAcGFyYW0gW1N0cmluZ10gcGF0aCBUaGUgcGF0aCB0byBhZGQgdG8gdGhlIGluZGV4LlxyXG4gICAqIEBwYXJhbSBbQnJvd3NlckZTLkZpbGVJbm9kZSB8IEJyb3dzZXJGUy5EaXJJbm9kZV0gaW5vZGUgVGhlIGlub2RlIGZvciB0aGVcclxuICAgKiAgIHBhdGggdG8gYWRkLlxyXG4gICAqIEByZXR1cm4gW0Jvb2xlYW5dICdUcnVlJyBpZiBpdCB3YXMgYWRkZWQgb3IgYWxyZWFkeSBleGlzdHMsICdmYWxzZScgaWYgdGhlcmVcclxuICAgKiAgIHdhcyBhbiBpc3N1ZSBhZGRpbmcgaXQgKGUuZy4gaXRlbSBpbiBwYXRoIGlzIGEgZmlsZSwgaXRlbSBleGlzdHMgYnV0IGlzXHJcbiAgICogICBkaWZmZXJlbnQpLlxyXG4gICAqIEB0b2RvIElmIGFkZGluZyBmYWlscyBhbmQgaW1wbGljaXRseSBjcmVhdGVzIGRpcmVjdG9yaWVzLCB3ZSBkbyBub3QgY2xlYW4gdXBcclxuICAgKiAgIHRoZSBuZXcgZW1wdHkgZGlyZWN0b3JpZXMuXHJcbiAgICovXHJcbiAgcHVibGljIGFkZFBhdGhGYXN0KHBhdGg6IHN0cmluZywgaW5vZGU6IElub2RlKTogYm9vbGVhbiB7XHJcblxyXG4gICAgY29uc3QgaXRlbU5hbWVNYXJrID0gcGF0aC5sYXN0SW5kZXhPZignLycpO1xyXG4gICAgY29uc3QgcGFyZW50UGF0aCA9IGl0ZW1OYW1lTWFyayA9PSAwID8gXCIvXCIgOiBwYXRoLnN1YnN0cmluZygwLCBpdGVtTmFtZU1hcmspO1xyXG4gICAgY29uc3QgaXRlbU5hbWUgPSBwYXRoLnN1YnN0cmluZyhpdGVtTmFtZU1hcmsrMSk7XHJcblxyXG4gICAgLy8gVHJ5IHRvIGFkZCB0byBpdHMgcGFyZW50IGRpcmVjdG9yeSBmaXJzdC5cclxuICAgIGxldCBwYXJlbnQgPSB0aGlzLl9pbmRleFtwYXJlbnRQYXRoXTtcclxuICAgIGlmIChwYXJlbnQgPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICAvLyBDcmVhdGUgcGFyZW50LlxyXG4gICAgICBwYXJlbnQgPSBuZXcgRGlySW5vZGU8VD4oKTtcclxuICAgICAgdGhpcy5hZGRQYXRoRmFzdChwYXJlbnRQYXRoLCBwYXJlbnQpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICghcGFyZW50LmFkZEl0ZW0oaXRlbU5hbWUsIGlub2RlKSkge1xyXG4gICAgICByZXR1cm4gZmFsc2U7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gSWYgYWRkaW5nIGEgZGlyZWN0b3J5LCBhZGQgdG8gdGhlIGluZGV4IGFzIHdlbGwuXHJcbiAgICBpZiAoaW5vZGUuaXNEaXIoKSkge1xyXG4gICAgICB0aGlzLl9pbmRleFtwYXRoXSA9IDxEaXJJbm9kZTxUPj4gaW5vZGU7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlbW92ZXMgdGhlIGdpdmVuIHBhdGguIENhbiBiZSBhIGZpbGUgb3IgYSBkaXJlY3RvcnkuXHJcbiAgICogQHJldHVybiBbQnJvd3NlckZTLkZpbGVJbm9kZSB8IEJyb3dzZXJGUy5EaXJJbm9kZSB8IG51bGxdIFRoZSByZW1vdmVkIGl0ZW0sXHJcbiAgICogICBvciBudWxsIGlmIGl0IGRpZCBub3QgZXhpc3QuXHJcbiAgICovXHJcbiAgcHVibGljIHJlbW92ZVBhdGgocGF0aDogc3RyaW5nKTogSW5vZGUge1xyXG4gICAgdmFyIHNwbGl0UGF0aCA9IHRoaXMuX3NwbGl0X3BhdGgocGF0aCk7XHJcbiAgICB2YXIgZGlycGF0aCA9IHNwbGl0UGF0aFswXTtcclxuICAgIHZhciBpdGVtbmFtZSA9IHNwbGl0UGF0aFsxXTtcclxuXHJcbiAgICAvLyBUcnkgdG8gcmVtb3ZlIGl0IGZyb20gaXRzIHBhcmVudCBkaXJlY3RvcnkgZmlyc3QuXHJcbiAgICB2YXIgcGFyZW50ID0gdGhpcy5faW5kZXhbZGlycGF0aF07XHJcbiAgICBpZiAocGFyZW50ID09PSB1bmRlZmluZWQpIHtcclxuICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICB9XHJcbiAgICAvLyBSZW1vdmUgbXlzZWxmIGZyb20gbXkgcGFyZW50LlxyXG4gICAgdmFyIGlub2RlID0gcGFyZW50LnJlbUl0ZW0oaXRlbW5hbWUpO1xyXG4gICAgaWYgKGlub2RlID09PSBudWxsKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgLy8gSWYgSSdtIGEgZGlyZWN0b3J5LCByZW1vdmUgbXlzZWxmIGZyb20gdGhlIGluZGV4LCBhbmQgcmVtb3ZlIG15IGNoaWxkcmVuLlxyXG4gICAgaWYgKGlzRGlySW5vZGUoaW5vZGUpKSB7XHJcbiAgICAgIHZhciBjaGlsZHJlbiA9IGlub2RlLmdldExpc3RpbmcoKTtcclxuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBjaGlsZHJlbi5sZW5ndGg7IGkrKykge1xyXG4gICAgICAgIHRoaXMucmVtb3ZlUGF0aChwYXRoICsgJy8nICsgY2hpbGRyZW5baV0pO1xyXG4gICAgICB9XHJcblxyXG4gICAgICAvLyBSZW1vdmUgdGhlIGRpcmVjdG9yeSBmcm9tIHRoZSBpbmRleCwgdW5sZXNzIGl0J3MgdGhlIHJvb3QuXHJcbiAgICAgIGlmIChwYXRoICE9PSAnLycpIHtcclxuICAgICAgICBkZWxldGUgdGhpcy5faW5kZXhbcGF0aF07XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBpbm9kZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHJpZXZlcyB0aGUgZGlyZWN0b3J5IGxpc3Rpbmcgb2YgdGhlIGdpdmVuIHBhdGguXHJcbiAgICogQHJldHVybiBbU3RyaW5nW11dIEFuIGFycmF5IG9mIGZpbGVzIGluIHRoZSBnaXZlbiBwYXRoLCBvciAnbnVsbCcgaWYgaXQgZG9lc1xyXG4gICAqICAgbm90IGV4aXN0LlxyXG4gICAqL1xyXG4gIHB1YmxpYyBscyhwYXRoOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICB2YXIgaXRlbSA9IHRoaXMuX2luZGV4W3BhdGhdO1xyXG4gICAgaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIHJldHVybiBpdGVtLmdldExpc3RpbmcoKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIGlub2RlIG9mIHRoZSBnaXZlbiBpdGVtLlxyXG4gICAqIEBwYXJhbSBbU3RyaW5nXSBwYXRoXHJcbiAgICogQHJldHVybiBbQnJvd3NlckZTLkZpbGVJbm9kZSB8IEJyb3dzZXJGUy5EaXJJbm9kZSB8IG51bGxdIFJldHVybnMgbnVsbCBpZlxyXG4gICAqICAgdGhlIGl0ZW0gZG9lcyBub3QgZXhpc3QuXHJcbiAgICovXHJcbiAgcHVibGljIGdldElub2RlKHBhdGg6IHN0cmluZyk6IElub2RlIHtcclxuICAgIHZhciBzcGxpdFBhdGggPSB0aGlzLl9zcGxpdF9wYXRoKHBhdGgpO1xyXG4gICAgdmFyIGRpcnBhdGggPSBzcGxpdFBhdGhbMF07XHJcbiAgICB2YXIgaXRlbW5hbWUgPSBzcGxpdFBhdGhbMV07XHJcbiAgICAvLyBSZXRyaWV2ZSBmcm9tIGl0cyBwYXJlbnQgZGlyZWN0b3J5LlxyXG4gICAgdmFyIHBhcmVudCA9IHRoaXMuX2luZGV4W2RpcnBhdGhdO1xyXG4gICAgaWYgKHBhcmVudCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgIHJldHVybiBudWxsO1xyXG4gICAgfVxyXG4gICAgLy8gUm9vdCBjYXNlXHJcbiAgICBpZiAoZGlycGF0aCA9PT0gcGF0aCkge1xyXG4gICAgICByZXR1cm4gcGFyZW50O1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHBhcmVudC5nZXRJdGVtKGl0ZW1uYW1lKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0YXRpYyBtZXRob2QgZm9yIGNvbnN0cnVjdGluZyBpbmRpY2VzIGZyb20gYSBKU09OIGxpc3RpbmcuXHJcbiAgICogQHBhcmFtIFtPYmplY3RdIGxpc3RpbmcgRGlyZWN0b3J5IGxpc3RpbmcgZ2VuZXJhdGVkIGJ5IHRvb2xzL1hIUkluZGV4ZXIuY29mZmVlXHJcbiAgICogQHJldHVybiBbQnJvd3NlckZTLkZpbGVJbmRleF0gQSBuZXcgRmlsZUluZGV4IG9iamVjdC5cclxuICAgKi9cclxuICBwdWJsaWMgc3RhdGljIGZyb21MaXN0aW5nPFQ+KGxpc3RpbmcpOiBGaWxlSW5kZXg8VD4ge1xyXG4gICAgdmFyIGlkeCA9IG5ldyBGaWxlSW5kZXg8VD4oKTtcclxuICAgIC8vIEFkZCBhIHJvb3QgRGlyTm9kZS5cclxuICAgIHZhciByb290SW5vZGUgPSBuZXcgRGlySW5vZGU8VD4oKTtcclxuICAgIGlkeC5faW5kZXhbJy8nXSA9IHJvb3RJbm9kZTtcclxuICAgIHZhciBxdWV1ZSA9IFtbJycsIGxpc3RpbmcsIHJvb3RJbm9kZV1dO1xyXG4gICAgd2hpbGUgKHF1ZXVlLmxlbmd0aCA+IDApIHtcclxuICAgICAgdmFyIGlub2RlO1xyXG4gICAgICB2YXIgbmV4dCA9IHF1ZXVlLnBvcCgpO1xyXG4gICAgICB2YXIgcHdkID0gbmV4dFswXTtcclxuICAgICAgdmFyIHRyZWUgPSBuZXh0WzFdO1xyXG4gICAgICB2YXIgcGFyZW50ID0gbmV4dFsyXTtcclxuICAgICAgZm9yICh2YXIgbm9kZSBpbiB0cmVlKSB7XHJcbiAgICAgICAgdmFyIGNoaWxkcmVuID0gdHJlZVtub2RlXTtcclxuICAgICAgICB2YXIgbmFtZSA9IFwiXCIgKyBwd2QgKyBcIi9cIiArIG5vZGU7XHJcbiAgICAgICAgaWYgKGNoaWxkcmVuICE9IG51bGwpIHtcclxuICAgICAgICAgIGlkeC5faW5kZXhbbmFtZV0gPSBpbm9kZSA9IG5ldyBEaXJJbm9kZTxUPigpO1xyXG4gICAgICAgICAgcXVldWUucHVzaChbbmFtZSwgY2hpbGRyZW4sIGlub2RlXSk7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgIC8vIFRoaXMgaW5vZGUgZG9lc24ndCBoYXZlIGNvcnJlY3Qgc2l6ZSBpbmZvcm1hdGlvbiwgbm90ZWQgd2l0aCAtMS5cclxuICAgICAgICAgIGlub2RlID0gbmV3IEZpbGVJbm9kZTxTdGF0cz4obmV3IFN0YXRzKEZpbGVUeXBlLkZJTEUsIC0xLCAweDE2RCkpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAocGFyZW50ICE9IG51bGwpIHtcclxuICAgICAgICAgIHBhcmVudC5fbHNbbm9kZV0gPSBpbm9kZTtcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuICAgIHJldHVybiBpZHg7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogR2VuZXJpYyBpbnRlcmZhY2UgZm9yIGZpbGUvZGlyZWN0b3J5IGlub2Rlcy5cclxuICogTm90ZSB0aGF0IFN0YXRzIG9iamVjdHMgYXJlIHdoYXQgd2UgdXNlIGZvciBmaWxlIGlub2Rlcy5cclxuICovXHJcbmV4cG9ydCBpbnRlcmZhY2UgSW5vZGUge1xyXG4gIC8vIElzIHRoaXMgYW4gaW5vZGUgZm9yIGEgZmlsZT9cclxuICBpc0ZpbGUoKTogYm9vbGVhbjtcclxuICAvLyBJcyB0aGlzIGFuIGlub2RlIGZvciBhIGRpcmVjdG9yeT9cclxuICBpc0RpcigpOiBib29sZWFuO1xyXG59XHJcblxyXG4vKipcclxuICogSW5vZGUgZm9yIGEgZmlsZS4gU3RvcmVzIGFuIGFyYml0cmFyeSAoZmlsZXN5c3RlbS1zcGVjaWZpYykgZGF0YSBwYXlsb2FkLlxyXG4gKi9cclxuZXhwb3J0IGNsYXNzIEZpbGVJbm9kZTxUPiBpbXBsZW1lbnRzIElub2RlIHtcclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGE6IFQpIHsgfVxyXG4gIHB1YmxpYyBpc0ZpbGUoKTogYm9vbGVhbiB7IHJldHVybiB0cnVlOyB9XHJcbiAgcHVibGljIGlzRGlyKCk6IGJvb2xlYW4geyByZXR1cm4gZmFsc2U7IH1cclxuICBwdWJsaWMgZ2V0RGF0YSgpOiBUIHsgcmV0dXJuIHRoaXMuZGF0YTsgfVxyXG4gIHB1YmxpYyBzZXREYXRhKGRhdGE6IFQpOiB2b2lkIHsgdGhpcy5kYXRhID0gZGF0YTsgfVxyXG59XHJcblxyXG4vKipcclxuICogSW5vZGUgZm9yIGEgZGlyZWN0b3J5LiBDdXJyZW50bHkgb25seSBjb250YWlucyB0aGUgZGlyZWN0b3J5IGxpc3RpbmcuXHJcbiAqL1xyXG5leHBvcnQgY2xhc3MgRGlySW5vZGU8VD4gaW1wbGVtZW50cyBJbm9kZSB7XHJcbiAgcHJpdmF0ZSBfbHM6IHtbcGF0aDogc3RyaW5nXTogSW5vZGV9ID0ge307XHJcbiAgLyoqXHJcbiAgICogQ29uc3RydWN0cyBhbiBpbm9kZSBmb3IgYSBkaXJlY3RvcnkuXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBkYXRhOiBUID0gbnVsbCkge31cclxuICBwdWJsaWMgaXNGaWxlKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuICBwdWJsaWMgaXNEaXIoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcbiAgcHVibGljIGdldERhdGEoKTogVCB7IHJldHVybiB0aGlzLmRhdGE7IH1cclxuXHJcbiAgLyoqXHJcbiAgICogUmV0dXJuIGEgU3RhdHMgb2JqZWN0IGZvciB0aGlzIGlub2RlLlxyXG4gICAqIEB0b2RvIFNob3VsZCBwcm9iYWJseSByZW1vdmUgdGhpcyBhdCBzb21lIHBvaW50LiBUaGlzIGlzbid0IHRoZVxyXG4gICAqICAgICAgIHJlc3BvbnNpYmlsaXR5IG9mIHRoZSBGaWxlSW5kZXguXHJcbiAgICogQHJldHVybiBbQnJvd3NlckZTLm5vZGUuZnMuU3RhdHNdXHJcbiAgICovXHJcbiAgcHVibGljIGdldFN0YXRzKCk6IFN0YXRzIHtcclxuICAgIHJldHVybiBuZXcgU3RhdHMoRmlsZVR5cGUuRElSRUNUT1JZLCA0MDk2LCAweDE2RCk7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIFJldHVybnMgdGhlIGRpcmVjdG9yeSBsaXN0aW5nIGZvciB0aGlzIGRpcmVjdG9yeS4gUGF0aHMgaW4gdGhlIGRpcmVjdG9yeSBhcmVcclxuICAgKiByZWxhdGl2ZSB0byB0aGUgZGlyZWN0b3J5J3MgcGF0aC5cclxuICAgKiBAcmV0dXJuIFtTdHJpbmdbXV0gVGhlIGRpcmVjdG9yeSBsaXN0aW5nIGZvciB0aGlzIGRpcmVjdG9yeS5cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0TGlzdGluZygpOiBzdHJpbmdbXSB7XHJcbiAgICByZXR1cm4gT2JqZWN0LmtleXModGhpcy5fbHMpO1xyXG4gIH1cclxuICAvKipcclxuICAgKiBSZXR1cm5zIHRoZSBpbm9kZSBmb3IgdGhlIGluZGljYXRlZCBpdGVtLCBvciBudWxsIGlmIGl0IGRvZXMgbm90IGV4aXN0LlxyXG4gICAqIEBwYXJhbSBbU3RyaW5nXSBwIE5hbWUgb2YgaXRlbSBpbiB0aGlzIGRpcmVjdG9yeS5cclxuICAgKiBAcmV0dXJuIFtCcm93c2VyRlMuRmlsZUlub2RlIHwgQnJvd3NlckZTLkRpcklub2RlIHwgbnVsbF1cclxuICAgKi9cclxuICBwdWJsaWMgZ2V0SXRlbShwOiBzdHJpbmcpOiBJbm9kZSB7XHJcbiAgICB2YXIgX3JlZjtcclxuICAgIHJldHVybiAoX3JlZiA9IHRoaXMuX2xzW3BdKSAhPSBudWxsID8gX3JlZiA6IG51bGw7XHJcbiAgfVxyXG4gIC8qKlxyXG4gICAqIEFkZCB0aGUgZ2l2ZW4gaXRlbSB0byB0aGUgZGlyZWN0b3J5IGxpc3RpbmcuIE5vdGUgdGhhdCB0aGUgZ2l2ZW4gaW5vZGUgaXNcclxuICAgKiBub3QgY29waWVkLCBhbmQgd2lsbCBiZSBtdXRhdGVkIGJ5IHRoZSBEaXJJbm9kZSBpZiBpdCBpcyBhIERpcklub2RlLlxyXG4gICAqIEBwYXJhbSBbU3RyaW5nXSBwIEl0ZW0gbmFtZSB0byBhZGQgdG8gdGhlIGRpcmVjdG9yeSBsaXN0aW5nLlxyXG4gICAqIEBwYXJhbSBbQnJvd3NlckZTLkZpbGVJbm9kZSB8IEJyb3dzZXJGUy5EaXJJbm9kZV0gaW5vZGUgVGhlIGlub2RlIGZvciB0aGVcclxuICAgKiAgIGl0ZW0gdG8gYWRkIHRvIHRoZSBkaXJlY3RvcnkgaW5vZGUuXHJcbiAgICogQHJldHVybiBbQm9vbGVhbl0gVHJ1ZSBpZiBpdCB3YXMgYWRkZWQsIGZhbHNlIGlmIGl0IGFscmVhZHkgZXhpc3RlZC5cclxuICAgKi9cclxuICBwdWJsaWMgYWRkSXRlbShwOiBzdHJpbmcsIGlub2RlOiBJbm9kZSk6IGJvb2xlYW4ge1xyXG4gICAgaWYgKHAgaW4gdGhpcy5fbHMpIHtcclxuICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fbHNbcF0gPSBpbm9kZTtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxuICAvKipcclxuICAgKiBSZW1vdmVzIHRoZSBnaXZlbiBpdGVtIGZyb20gdGhlIGRpcmVjdG9yeSBsaXN0aW5nLlxyXG4gICAqIEBwYXJhbSBbU3RyaW5nXSBwIE5hbWUgb2YgaXRlbSB0byByZW1vdmUgZnJvbSB0aGUgZGlyZWN0b3J5IGxpc3RpbmcuXHJcbiAgICogQHJldHVybiBbQnJvd3NlckZTLkZpbGVJbm9kZSB8IEJyb3dzZXJGUy5EaXJJbm9kZSB8IG51bGxdIFJldHVybnMgdGhlIGl0ZW1cclxuICAgKiAgIHJlbW92ZWQsIG9yIG51bGwgaWYgdGhlIGl0ZW0gZGlkIG5vdCBleGlzdC5cclxuICAgKi9cclxuICBwdWJsaWMgcmVtSXRlbShwOiBzdHJpbmcpOiBJbm9kZSB7XHJcbiAgICB2YXIgaXRlbSA9IHRoaXMuX2xzW3BdO1xyXG4gICAgaWYgKGl0ZW0gPT09IHVuZGVmaW5lZCkge1xyXG4gICAgICByZXR1cm4gbnVsbDtcclxuICAgIH1cclxuICAgIGRlbGV0ZSB0aGlzLl9sc1twXTtcclxuICAgIHJldHVybiBpdGVtO1xyXG4gIH1cclxufVxyXG5cclxuZXhwb3J0IGZ1bmN0aW9uIGlzRmlsZUlub2RlPFQ+KGlub2RlOiBJbm9kZSk6IGlub2RlIGlzIEZpbGVJbm9kZTxUPiB7XHJcbiAgcmV0dXJuIGlub2RlICYmIGlub2RlLmlzRmlsZSgpO1xyXG59XHJcblxyXG5leHBvcnQgZnVuY3Rpb24gaXNEaXJJbm9kZTxUPihpbm9kZTogSW5vZGUpOiBpbm9kZSBpcyBEaXJJbm9kZTxUPiB7XHJcbiAgcmV0dXJuIGlub2RlICYmIGlub2RlLmlzRGlyKCk7XHJcbn1cclxuIl19