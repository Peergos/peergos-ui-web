"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var api_error_1 = require('../core/api_error');
var file_flag_1 = require('../core/file_flag');
var util_1 = require('../core/util');
var preload_file = require('../generic/preload_file');
var xhr = require('../generic/xhr');
var file_index_1 = require('../generic/file_index');
function tryToString(buff, encoding, cb) {
    try {
        cb(null, buff.toString(encoding));
    }
    catch (e) {
        cb(e);
    }
}
var XmlHttpRequest = (function (_super) {
    __extends(XmlHttpRequest, _super);
    function XmlHttpRequest(listingUrlOrObj, prefixUrl) {
        if (prefixUrl === void 0) { prefixUrl = ''; }
        _super.call(this);
        if (!listingUrlOrObj) {
            listingUrlOrObj = 'index.json';
        }
        if (prefixUrl.length > 0 && prefixUrl.charAt(prefixUrl.length - 1) !== '/') {
            prefixUrl = prefixUrl + '/';
        }
        this.prefixUrl = prefixUrl;
        var listing = null;
        if (typeof (listingUrlOrObj) === "string") {
            listing = this._requestFileSync(listingUrlOrObj, 'json');
            if (!listing) {
                throw new Error("Unable to find listing at URL: ${listingUrlOrObj}");
            }
        }
        else {
            listing = listingUrlOrObj;
        }
        this._index = file_index_1.FileIndex.fromListing(listing);
    }
    XmlHttpRequest.prototype.empty = function () {
        this._index.fileIterator(function (file) {
            file.file_data = null;
        });
    };
    XmlHttpRequest.prototype.getXhrPath = function (filePath) {
        if (filePath.charAt(0) === '/') {
            filePath = filePath.slice(1);
        }
        return this.prefixUrl + filePath;
    };
    XmlHttpRequest.prototype._requestFileSizeAsync = function (path, cb) {
        xhr.getFileSizeAsync(this.getXhrPath(path), cb);
    };
    XmlHttpRequest.prototype._requestFileSizeSync = function (path) {
        return xhr.getFileSizeSync(this.getXhrPath(path));
    };
    XmlHttpRequest.prototype._requestFileAsync = function (p, type, cb) {
        xhr.asyncDownloadFile(this.getXhrPath(p), type, cb);
    };
    XmlHttpRequest.prototype._requestFileSync = function (p, type) {
        return xhr.syncDownloadFile(this.getXhrPath(p), type);
    };
    XmlHttpRequest.prototype.getName = function () {
        return 'XmlHttpRequest';
    };
    XmlHttpRequest.isAvailable = function () {
        return typeof XMLHttpRequest !== "undefined" && XMLHttpRequest !== null;
    };
    XmlHttpRequest.prototype.diskSpace = function (path, cb) {
        cb(0, 0);
    };
    XmlHttpRequest.prototype.isReadOnly = function () {
        return true;
    };
    XmlHttpRequest.prototype.supportsLinks = function () {
        return false;
    };
    XmlHttpRequest.prototype.supportsProps = function () {
        return false;
    };
    XmlHttpRequest.prototype.supportsSynch = function () {
        return true;
    };
    XmlHttpRequest.prototype.preloadFile = function (path, buffer) {
        var inode = this._index.getInode(path);
        if (file_index_1.isFileInode(inode)) {
            if (inode === null) {
                throw api_error_1.ApiError.ENOENT(path);
            }
            var stats = inode.getData();
            stats.size = buffer.length;
            stats.file_data = buffer;
        }
        else {
            throw api_error_1.ApiError.EISDIR(path);
        }
    };
    XmlHttpRequest.prototype.stat = function (path, isLstat, cb) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            return cb(api_error_1.ApiError.ENOENT(path));
        }
        var stats;
        if (file_index_1.isFileInode(inode)) {
            stats = inode.getData();
            if (stats.size < 0) {
                this._requestFileSizeAsync(path, function (e, size) {
                    if (e) {
                        return cb(e);
                    }
                    stats.size = size;
                    cb(null, stats.clone());
                });
            }
            else {
                cb(null, stats.clone());
            }
        }
        else if (file_index_1.isDirInode(inode)) {
            stats = inode.getStats();
            cb(null, stats);
        }
        else {
            cb(api_error_1.ApiError.FileError(api_error_1.ErrorCode.EINVAL, path));
        }
    };
    XmlHttpRequest.prototype.statSync = function (path, isLstat) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        var stats;
        if (file_index_1.isFileInode(inode)) {
            stats = inode.getData();
            if (stats.size < 0) {
                stats.size = this._requestFileSizeSync(path);
            }
        }
        else if (file_index_1.isDirInode(inode)) {
            stats = inode.getStats();
        }
        else {
            throw api_error_1.ApiError.FileError(api_error_1.ErrorCode.EINVAL, path);
        }
        return stats;
    };
    XmlHttpRequest.prototype.open = function (path, flags, mode, cb) {
        if (flags.isWriteable()) {
            return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EPERM, path));
        }
        var _this = this;
        var inode = this._index.getInode(path);
        if (inode === null) {
            return cb(api_error_1.ApiError.ENOENT(path));
        }
        if (file_index_1.isFileInode(inode)) {
            var stats = inode.getData();
            switch (flags.pathExistsAction()) {
                case file_flag_1.ActionType.THROW_EXCEPTION:
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    return cb(api_error_1.ApiError.EEXIST(path));
                case file_flag_1.ActionType.NOP:
                    if (stats.file_data != null) {
                        return cb(null, new preload_file.NoSyncFile(_this, path, flags, stats.clone(), stats.file_data));
                    }
                    this._requestFileAsync(path, 'buffer', function (err, buffer) {
                        if (err) {
                            return cb(err);
                        }
                        stats.size = buffer.length;
                        stats.file_data = buffer;
                        return cb(null, new preload_file.NoSyncFile(_this, path, flags, stats.clone(), buffer));
                    });
                    break;
                default:
                    return cb(new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, 'Invalid FileMode object.'));
            }
        }
        else {
            return cb(api_error_1.ApiError.EISDIR(path));
        }
    };
    XmlHttpRequest.prototype.openSync = function (path, flags, mode) {
        if (flags.isWriteable()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EPERM, path);
        }
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        if (file_index_1.isFileInode(inode)) {
            var stats = inode.getData();
            switch (flags.pathExistsAction()) {
                case file_flag_1.ActionType.THROW_EXCEPTION:
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    throw api_error_1.ApiError.EEXIST(path);
                case file_flag_1.ActionType.NOP:
                    if (stats.file_data != null) {
                        return new preload_file.NoSyncFile(this, path, flags, stats.clone(), stats.file_data);
                    }
                    var buffer = this._requestFileSync(path, 'buffer');
                    stats.size = buffer.length;
                    stats.file_data = buffer;
                    return new preload_file.NoSyncFile(this, path, flags, stats.clone(), buffer);
                default:
                    throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, 'Invalid FileMode object.');
            }
        }
        else {
            throw api_error_1.ApiError.EISDIR(path);
        }
    };
    XmlHttpRequest.prototype.readdir = function (path, cb) {
        try {
            cb(null, this.readdirSync(path));
        }
        catch (e) {
            cb(e);
        }
    };
    XmlHttpRequest.prototype.readdirSync = function (path) {
        var inode = this._index.getInode(path);
        if (inode === null) {
            throw api_error_1.ApiError.ENOENT(path);
        }
        else if (file_index_1.isDirInode(inode)) {
            return inode.getListing();
        }
        else {
            throw api_error_1.ApiError.ENOTDIR(path);
        }
    };
    XmlHttpRequest.prototype.readFile = function (fname, encoding, flag, cb) {
        var oldCb = cb;
        this.open(fname, flag, 0x1a4, function (err, fd) {
            if (err) {
                return cb(err);
            }
            cb = function (err, arg) {
                fd.close(function (err2) {
                    if (err == null) {
                        err = err2;
                    }
                    return oldCb(err, arg);
                });
            };
            var fdCast = fd;
            var fdBuff = fdCast.getBuffer();
            if (encoding === null) {
                cb(err, util_1.copyingSlice(fdBuff));
            }
            else {
                tryToString(fdBuff, encoding, cb);
            }
        });
    };
    XmlHttpRequest.prototype.readFileSync = function (fname, encoding, flag) {
        var fd = this.openSync(fname, flag, 0x1a4);
        try {
            var fdCast = fd;
            var fdBuff = fdCast.getBuffer();
            if (encoding === null) {
                return util_1.copyingSlice(fdBuff);
            }
            return fdBuff.toString(encoding);
        }
        finally {
            fd.closeSync();
        }
    };
    return XmlHttpRequest;
}(file_system.BaseFileSystem));
exports.__esModule = true;
exports["default"] = XmlHttpRequest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiWG1sSHR0cFJlcXVlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvYmFja2VuZC9YbWxIdHRwUmVxdWVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7QUFBQSxJQUFPLFdBQVcsV0FBVyxxQkFBcUIsQ0FBQyxDQUFDO0FBQ3BELDBCQUFrQyxtQkFBbUIsQ0FBQyxDQUFBO0FBQ3RELDBCQUFtQyxtQkFBbUIsQ0FBQyxDQUFBO0FBQ3ZELHFCQUEyQixjQUFjLENBQUMsQ0FBQTtBQUcxQyxJQUFPLFlBQVksV0FBVyx5QkFBeUIsQ0FBQyxDQUFDO0FBQ3pELElBQU8sR0FBRyxXQUFXLGdCQUFnQixDQUFDLENBQUM7QUFDdkMsMkJBQTZFLHVCQUF1QixDQUFDLENBQUE7QUFPckcscUJBQXFCLElBQVksRUFBRSxRQUFnQixFQUFFLEVBQXNDO0lBQ3pGLElBQUksQ0FBQztRQUNILEVBQUUsQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDO0lBQ3BDLENBQUU7SUFBQSxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ1gsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ1IsQ0FBQztBQUNILENBQUM7QUFLRDtJQUE0QyxrQ0FBMEI7SUFVcEUsd0JBQVksZUFBZ0MsRUFBRSxTQUFzQjtRQUF0Qix5QkFBc0IsR0FBdEIsY0FBc0I7UUFDbEUsaUJBQU8sQ0FBQztRQUNSLEVBQUUsQ0FBQyxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUNyQixlQUFlLEdBQUcsWUFBWSxDQUFDO1FBQ2pDLENBQUM7UUFFRCxFQUFFLENBQUMsQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsSUFBSSxTQUFTLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsQ0FBQztZQUMzRSxTQUFTLEdB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Jy4uL2NvcmUvZmlsZV9zeXN0ZW0nKTtcclxuaW1wb3J0IHtBcGlFcnJvciwgRXJyb3JDb2RlfSBmcm9tICcuLi9jb3JlL2FwaV9lcnJvcic7XHJcbmltcG9ydCB7RmlsZUZsYWcsIEFjdGlvblR5cGV9IGZyb20gJy4uL2NvcmUvZmlsZV9mbGFnJztcclxuaW1wb3J0IHtjb3B5aW5nU2xpY2V9IGZyb20gJy4uL2NvcmUvdXRpbCc7XHJcbmltcG9ydCBmaWxlID0gcmVxdWlyZSgnLi4vY29yZS9maWxlJyk7XHJcbmltcG9ydCBTdGF0cyBmcm9tICcuLi9jb3JlL25vZGVfZnNfc3RhdHMnO1xyXG5pbXBvcnQgcHJlbG9hZF9maWxlID0gcmVxdWlyZSgnLi4vZ2VuZXJpYy9wcmVsb2FkX2ZpbGUnKTtcclxuaW1wb3J0IHhociA9IHJlcXVpcmUoJy4uL2dlbmVyaWMveGhyJyk7XHJcbmltcG9ydCB7RmlsZUluZGV4LCBEaXJJbm9kZSwgRmlsZUlub2RlLCBJbm9kZSwgaXNGaWxlSW5vZGUsIGlzRGlySW5vZGV9IGZyb20gJy4uL2dlbmVyaWMvZmlsZV9pbmRleCc7XHJcblxyXG4vKipcclxuICogVHJ5IHRvIGNvbnZlcnQgdGhlIGdpdmVuIGJ1ZmZlciBpbnRvIGEgc3RyaW5nLCBhbmQgcGFzcyBpdCB0byB0aGUgY2FsbGJhY2suXHJcbiAqIE9wdGltaXphdGlvbiB0aGF0IHJlbW92ZXMgdGhlIG5lZWRlZCB0cnkvY2F0Y2ggaW50byBhIGhlbHBlciBmdW5jdGlvbiwgYXNcclxuICogdGhpcyBpcyBhbiB1bmNvbW1vbiBjYXNlLlxyXG4gKi9cclxuZnVuY3Rpb24gdHJ5VG9TdHJpbmcoYnVmZjogQnVmZmVyLCBlbmNvZGluZzogc3RyaW5nLCBjYjogKGU6IEFwaUVycm9yLCBydj86IHN0cmluZykgPT4gdm9pZCkge1xyXG4gIHRyeSB7XHJcbiAgICBjYihudWxsLCBidWZmLnRvU3RyaW5nKGVuY29kaW5nKSk7XHJcbiAgfSBjYXRjaCAoZSkge1xyXG4gICAgY2IoZSk7XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQSBzaW1wbGUgZmlsZXN5c3RlbSBiYWNrZWQgYnkgWG1sSHR0cFJlcXVlc3RzLlxyXG4gKi9cclxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgWG1sSHR0cFJlcXVlc3QgZXh0ZW5kcyBmaWxlX3N5c3RlbS5CYXNlRmlsZVN5c3RlbSBpbXBsZW1lbnRzIGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0ge1xyXG4gIHByaXZhdGUgX2luZGV4OiBGaWxlSW5kZXg8e30+O1xyXG4gIHB1YmxpYyBwcmVmaXhVcmw6IHN0cmluZztcclxuICAvKipcclxuICAgKiBDb25zdHJ1Y3RzIHRoZSBmaWxlIHN5c3RlbS5cclxuICAgKiBAcGFyYW0gbGlzdGluZ1VybE9yT2JqIGluZGV4IG9iamVjdCBvciB0aGUgcGF0aCB0byB0aGUgSlNPTiBmaWxlIGluZGV4IGdlbmVyYXRlZCBieVxyXG4gICAqICAgdG9vbHMvWEhSSW5kZXhlci5jb2ZmZWUuIFRoaXMgY2FuIGJlIHJlbGF0aXZlIHRvIHRoZSBjdXJyZW50IHdlYnBhZ2UgVVJMXHJcbiAgICogICBvciBhYnNvbHV0ZWx5IHNwZWNpZmllZC5cclxuICAgKiBAcGFyYW0gcHJlZml4VXJsIFRoZSB1cmwgcHJlZml4IHRvIHVzZSBmb3IgYWxsIHdlYi1zZXJ2ZXIgcmVxdWVzdHMuXHJcbiAgICovXHJcbiAgY29uc3RydWN0b3IobGlzdGluZ1VybE9yT2JqOiBzdHJpbmcgfCBPYmplY3QsIHByZWZpeFVybDogc3RyaW5nID0gJycpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICBpZiAoIWxpc3RpbmdVcmxPck9iaikge1xyXG4gICAgICBsaXN0aW5nVXJsT3JPYmogPSAnaW5kZXguanNvbic7XHJcbiAgICB9XHJcbiAgICAvLyBwcmVmaXhfdXJsIG11c3QgZW5kIGluIGEgZGlyZWN0b3J5IHNlcGFyYXRvci5cclxuICAgIGlmIChwcmVmaXhVcmwubGVuZ3RoID4gMCAmJiBwcmVmaXhVcmwuY2hhckF0KHByZWZpeFVybC5sZW5ndGggLSAxKSAhPT0gJy8nKSB7XHJcbiAgICAgIHByZWZpeFVybCA9IHByZWZpeFVybCArICcvJztcclxuICAgIH1cclxuICAgIHRoaXMucHJlZml4VXJsID0gcHJlZml4VXJsO1xyXG5cclxuICAgIGxldCBsaXN0aW5nOiBPYmplY3QgPSBudWxsO1xyXG4gICAgaWYgKHR5cGVvZihsaXN0aW5nVXJsT3JPYmopID09PSBcInN0cmluZ1wiKSB7XHJcbiAgICAgIGxpc3RpbmcgPSB0aGlzLl9yZXF1ZXN0RmlsZVN5bmMoPHN0cmluZz4gbGlzdGluZ1VybE9yT2JqLCAnanNvbicpO1xyXG4gICAgICBpZiAoIWxpc3RpbmcpIHtcclxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gZmluZCBsaXN0aW5nIGF0IFVSTDogJHtsaXN0aW5nVXJsT3JPYmp9XCIpO1xyXG4gICAgICB9XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBsaXN0aW5nID0gbGlzdGluZ1VybE9yT2JqO1xyXG4gICAgfVxyXG5cclxuICAgIHRoaXMuX2luZGV4ID0gRmlsZUluZGV4LmZyb21MaXN0aW5nKGxpc3RpbmcpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGVtcHR5KCk6IHZvaWQge1xyXG4gICAgdGhpcy5faW5kZXguZmlsZUl0ZXJhdG9yKGZ1bmN0aW9uKGZpbGU6IFN0YXRzKSB7XHJcbiAgICAgIGZpbGUuZmlsZV9kYXRhID0gbnVsbDtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBnZXRYaHJQYXRoKGZpbGVQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xyXG4gICAgaWYgKGZpbGVQYXRoLmNoYXJBdCgwKSA9PT0gJy8nKSB7XHJcbiAgICAgIGZpbGVQYXRoID0gZmlsZVBhdGguc2xpY2UoMSk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5wcmVmaXhVcmwgKyBmaWxlUGF0aDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIE9ubHkgcmVxdWVzdHMgdGhlIEhFQUQgY29udGVudCwgZm9yIHRoZSBmaWxlIHNpemUuXHJcbiAgICovXHJcbiAgcHVibGljIF9yZXF1ZXN0RmlsZVNpemVBc3luYyhwYXRoOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgc2l6ZT86IG51bWJlcikgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgeGhyLmdldEZpbGVTaXplQXN5bmModGhpcy5nZXRYaHJQYXRoKHBhdGgpLCBjYik7XHJcbiAgfVxyXG4gIHB1YmxpYyBfcmVxdWVzdEZpbGVTaXplU3luYyhwYXRoOiBzdHJpbmcpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHhoci5nZXRGaWxlU2l6ZVN5bmModGhpcy5nZXRYaHJQYXRoKHBhdGgpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEFzeW5jaHJvbm91c2x5IGRvd25sb2FkIHRoZSBnaXZlbiBmaWxlLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlQXN5bmMocDogc3RyaW5nLCB0eXBlOiAnYnVmZmVyJywgY2I6IChlcnI6IEFwaUVycm9yLCBkYXRhPzogTm9kZUJ1ZmZlcikgPT4gdm9pZCk6IHZvaWQ7XHJcbiAgcHJpdmF0ZSBfcmVxdWVzdEZpbGVBc3luYyhwOiBzdHJpbmcsIHR5cGU6ICdqc29uJywgY2I6IChlcnI6IEFwaUVycm9yLCBkYXRhPzogYW55KSA9PiB2b2lkKTogdm9pZDtcclxuICBwcml2YXRlIF9yZXF1ZXN0RmlsZUFzeW5jKHA6IHN0cmluZywgdHlwZTogc3RyaW5nLCBjYjogKGVycjogQXBpRXJyb3IsIGRhdGE/OiBhbnkpID0+IHZvaWQpOiB2b2lkO1xyXG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlQXN5bmMocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgeGhyLmFzeW5jRG93bmxvYWRGaWxlKHRoaXMuZ2V0WGhyUGF0aChwKSwgdHlwZSwgY2IpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3luY2hyb25vdXNseSBkb3dubG9hZCB0aGUgZ2l2ZW4gZmlsZS5cclxuICAgKi9cclxuICBwcml2YXRlIF9yZXF1ZXN0RmlsZVN5bmMocDogc3RyaW5nLCB0eXBlOiAnYnVmZmVyJyk6IE5vZGVCdWZmZXI7XHJcbiAgcHJpdmF0ZSBfcmVxdWVzdEZpbGVTeW5jKHA6IHN0cmluZywgdHlwZTogJ2pzb24nKTogYW55O1xyXG4gIHByaXZhdGUgX3JlcXVlc3RGaWxlU3luYyhwOiBzdHJpbmcsIHR5cGU6IHN0cmluZyk6IGFueTtcclxuICBwcml2YXRlIF9yZXF1ZXN0RmlsZVN5bmMocDogc3RyaW5nLCB0eXBlOiBzdHJpbmcpOiBhbnkge1xyXG4gICAgcmV0dXJuIHhoci5zeW5jRG93bmxvYWRGaWxlKHRoaXMuZ2V0WGhyUGF0aChwKSwgdHlwZSk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZ2V0TmFtZSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuICdYbWxIdHRwUmVxdWVzdCc7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3RhdGljIGlzQXZhaWxhYmxlKCk6IGJvb2xlYW4ge1xyXG4gICAgLy8gQHRvZG8gT2xkZXIgYnJvd3NlcnMgdXNlIGEgZGlmZmVyZW50IG5hbWUgZm9yIFhIUiwgaWlyYy5cclxuICAgIHJldHVybiB0eXBlb2YgWE1MSHR0cFJlcXVlc3QgIT09IFwidW5kZWZpbmVkXCIgJiYgWE1MSHR0cFJlcXVlc3QgIT09IG51bGw7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgZGlza1NwYWNlKHBhdGg6IHN0cmluZywgY2I6ICh0b3RhbDogbnVtYmVyLCBmcmVlOiBudW1iZXIpID0+IHZvaWQpOiB2b2lkIHtcclxuICAgIC8vIFJlYWQtb25seSBmaWxlIHN5c3RlbS4gV2UgY291bGQgY2FsY3VsYXRlIHRoZSB0b3RhbCBzcGFjZSwgYnV0IHRoYXQncyBub3RcclxuICAgIC8vIGltcG9ydGFudCByaWdodCBub3cuXHJcbiAgICBjYigwLCAwKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBpc1JlYWRPbmx5KCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIHRydWU7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgc3VwcG9ydHNMaW5rcygpOiBib29sZWFuIHtcclxuICAgIHJldHVybiBmYWxzZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdXBwb3J0c1Byb3BzKCk6IGJvb2xlYW4ge1xyXG4gICAgcmV0dXJuIGZhbHNlO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFNwZWNpYWwgWEhSIGZ1bmN0aW9uOiBQcmVsb2FkIHRoZSBnaXZlbiBmaWxlIGludG8gdGhlIGluZGV4LlxyXG4gICAqIEBwYXJhbSBbU3RyaW5nXSBwYXRoXHJcbiAgICogQHBhcmFtIFtCcm93c2VyRlMuQnVmZmVyXSBidWZmZXJcclxuICAgKi9cclxuICBwdWJsaWMgcHJlbG9hZEZpbGUocGF0aDogc3RyaW5nLCBidWZmZXI6IE5vZGVCdWZmZXIpOiB2b2lkIHtcclxuICAgIHZhciBpbm9kZSA9IHRoaXMuX2luZGV4LmdldElub2RlKHBhdGgpO1xyXG4gICAgaWYgKGlzRmlsZUlub2RlPFN0YXRzPihpbm9kZSkpIHtcclxuICAgICAgaWYgKGlub2RlID09PSBudWxsKSB7XHJcbiAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHBhdGgpO1xyXG4gICAgICB9XHJcbiAgICAgIHZhciBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcclxuICAgICAgc3RhdHMuc2l6ZSA9IGJ1ZmZlci5sZW5ndGg7XHJcbiAgICAgIHN0YXRzLmZpbGVfZGF0YSA9IGJ1ZmZlcjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IEFwaUVycm9yLkVJU0RJUihwYXRoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0KHBhdGg6IHN0cmluZywgaXNMc3RhdDogYm9vbGVhbiwgY2I6IChlOiBBcGlFcnJvciwgc3RhdD86IFN0YXRzKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB2YXIgaW5vZGUgPSB0aGlzLl9pbmRleC5nZXRJbm9kZShwYXRoKTtcclxuICAgIGlmIChpbm9kZSA9PT0gbnVsbCkge1xyXG4gICAgICByZXR1cm4gY2IoQXBpRXJyb3IuRU5PRU5UKHBhdGgpKTtcclxuICAgIH1cclxuICAgIHZhciBzdGF0czogU3RhdHM7XHJcbiAgICBpZiAoaXNGaWxlSW5vZGU8U3RhdHM+KGlub2RlKSkge1xyXG4gICAgICBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcclxuICAgICAgLy8gQXQgdGhpcyBwb2ludCwgYSBub24tb3BlbmVkIGZpbGUgd2lsbCBzdGlsbCBoYXZlIGRlZmF1bHQgc3RhdHMgZnJvbSB0aGUgbGlzdGluZy5cclxuICAgICAgaWYgKHN0YXRzLnNpemUgPCAwKSB7XHJcbiAgICAgICAgdGhpcy5fcmVxdWVzdEZpbGVTaXplQXN5bmMocGF0aCwgZnVuY3Rpb24oZTogQXBpRXJyb3IsIHNpemU/OiBudW1iZXIpIHtcclxuICAgICAgICAgIGlmIChlKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBjYihlKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHN0YXRzLnNpemUgPSBzaXplO1xyXG4gICAgICAgICAgY2IobnVsbCwgc3RhdHMuY2xvbmUoKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgY2IobnVsbCwgc3RhdHMuY2xvbmUoKSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoaXNEaXJJbm9kZShpbm9kZSkpIHtcclxuICAgICAgc3RhdHMgPSBpbm9kZS5nZXRTdGF0cygpO1xyXG4gICAgICBjYihudWxsLCBzdGF0cyk7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICBjYihBcGlFcnJvci5GaWxlRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgcGF0aCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIHN0YXRTeW5jKHBhdGg6IHN0cmluZywgaXNMc3RhdDogYm9vbGVhbik6IFN0YXRzIHtcclxuICAgIHZhciBpbm9kZSA9IHRoaXMuX2luZGV4LmdldElub2RlKHBhdGgpO1xyXG4gICAgaWYgKGlub2RlID09PSBudWxsKSB7XHJcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwYXRoKTtcclxuICAgIH1cclxuICAgIHZhciBzdGF0czogU3RhdHM7XHJcbiAgICBpZiAoaXNGaWxlSW5vZGU8U3RhdHM+KGlub2RlKSkge1xyXG4gICAgICBzdGF0cyA9IGlub2RlLmdldERhdGEoKTtcclxuICAgICAgLy8gQXQgdGhpcyBwb2ludCwgYSBub24tb3BlbmVkIGZpbGUgd2lsbCBzdGlsbCBoYXZlIGRlZmF1bHQgc3RhdHMgZnJvbSB0aGUgbGlzdGluZy5cclxuICAgICAgaWYgKHN0YXRzLnNpemUgPCAwKSB7XHJcbiAgICAgICAgc3RhdHMuc2l6ZSA9IHRoaXMuX3JlcXVlc3RGaWxlU2l6ZVN5bmMocGF0aCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSBpZiAoaXNEaXJJbm9kZShpbm9kZSkpIHtcclxuICAgICAgc3RhdHMgPSBpbm9kZS5nZXRTdGF0cygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgQXBpRXJyb3IuRmlsZUVycm9yKEVycm9yQ29kZS5FSU5WQUwsIHBhdGgpO1xyXG4gICAgfVxyXG4gICAgcmV0dXJuIHN0YXRzO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIG9wZW4ocGF0aDogc3RyaW5nLCBmbGFnczogRmlsZUZsYWcsIG1vZGU6IG51bWJlciwgY2I6IChlOiBBcGlFcnJvciwgZmlsZT86IGZpbGUuRmlsZSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgLy8gSU5WQVJJQU5UOiBZb3UgY2FuJ3Qgd3JpdGUgdG8gZmlsZXMgb24gdGhpcyBmaWxlIHN5c3RlbS5cclxuICAgIGlmIChmbGFncy5pc1dyaXRlYWJsZSgpKSB7XHJcbiAgICAgIHJldHVybiBjYihuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVQRVJNLCBwYXRoKSk7XHJcbiAgICB9XHJcbiAgICB2YXIgX3RoaXMgPSB0aGlzO1xyXG4gICAgLy8gQ2hlY2sgaWYgdGhlIHBhdGggZXhpc3RzLCBhbmQgaXMgYSBmaWxlLlxyXG4gICAgdmFyIGlub2RlID0gdGhpcy5faW5kZXguZ2V0SW5vZGUocGF0aCk7XHJcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcclxuICAgICAgcmV0dXJuIGNiKEFwaUVycm9yLkVOT0VOVChwYXRoKSk7XHJcbiAgICB9XHJcbiAgICBpZiAoaXNGaWxlSW5vZGU8U3RhdHM+KGlub2RlKSkge1xyXG4gICAgICB2YXIgc3RhdHMgPSBpbm9kZS5nZXREYXRhKCk7XHJcbiAgICAgIHN3aXRjaCAoZmxhZ3MucGF0aEV4aXN0c0FjdGlvbigpKSB7XHJcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLlRIUk9XX0VYQ0VQVElPTjpcclxuICAgICAgICBjYXNlIEFjdGlvblR5cGUuVFJVTkNBVEVfRklMRTpcclxuICAgICAgICAgIHJldHVybiBjYihBcGlFcnJvci5FRVhJU1QocGF0aCkpO1xyXG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5OT1A6XHJcbiAgICAgICAgICAvLyBVc2UgZXhpc3RpbmcgZmlsZSBjb250ZW50cy5cclxuICAgICAgICAgIC8vIFhYWDogVWgsIHRoaXMgbWFpbnRhaW5zIHRoZSBwcmV2aW91c2x5LXVzZWQgZmxhZy5cclxuICAgICAgICAgIGlmIChzdGF0cy5maWxlX2RhdGEgIT0gbnVsbCkge1xyXG4gICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgbmV3IHByZWxvYWRfZmlsZS5Ob1N5bmNGaWxlKF90aGlzLCBwYXRoLCBmbGFncywgc3RhdHMuY2xvbmUoKSwgc3RhdHMuZmlsZV9kYXRhKSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyBAdG9kbyBiZSBsYXppZXIgYWJvdXQgYWN0dWFsbHkgcmVxdWVzdGluZyB0aGUgZmlsZVxyXG4gICAgICAgICAgdGhpcy5fcmVxdWVzdEZpbGVBc3luYyhwYXRoLCAnYnVmZmVyJywgZnVuY3Rpb24oZXJyOiBBcGlFcnJvciwgYnVmZmVyPzogTm9kZUJ1ZmZlcikge1xyXG4gICAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGNiKGVycik7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgLy8gd2UgZG9uJ3QgaW5pdGlhbGx5IGhhdmUgZmlsZSBzaXplc1xyXG4gICAgICAgICAgICBzdGF0cy5zaXplID0gYnVmZmVyLmxlbmd0aDtcclxuICAgICAgICAgICAgc3RhdHMuZmlsZV9kYXRhID0gYnVmZmVyO1xyXG4gICAgICAgICAgICByZXR1cm4gY2IobnVsbCwgbmV3IHByZWxvYWRfZmlsZS5Ob1N5bmNGaWxlKF90aGlzLCBwYXRoLCBmbGFncywgc3RhdHMuY2xvbmUoKSwgYnVmZmVyKSk7XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgICAgIGJyZWFrO1xyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICByZXR1cm4gY2IobmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsICdJbnZhbGlkIEZpbGVNb2RlIG9iamVjdC4nKSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHJldHVybiBjYihBcGlFcnJvci5FSVNESVIocGF0aCkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIG9wZW5TeW5jKHBhdGg6IHN0cmluZywgZmxhZ3M6IEZpbGVGbGFnLCBtb2RlOiBudW1iZXIpOiBmaWxlLkZpbGUge1xyXG4gICAgLy8gSU5WQVJJQU5UOiBZb3UgY2FuJ3Qgd3JpdGUgdG8gZmlsZXMgb24gdGhpcyBmaWxlIHN5c3RlbS5cclxuICAgIGlmIChmbGFncy5pc1dyaXRlYWJsZSgpKSB7XHJcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRVBFUk0sIHBhdGgpO1xyXG4gICAgfVxyXG4gICAgLy8gQ2hlY2sgaWYgdGhlIHBhdGggZXhpc3RzLCBhbmQgaXMgYSBmaWxlLlxyXG4gICAgdmFyIGlub2RlID0gdGhpcy5faW5kZXguZ2V0SW5vZGUocGF0aCk7XHJcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcclxuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHBhdGgpO1xyXG4gICAgfVxyXG4gICAgaWYgKGlzRmlsZUlub2RlPFN0YXRzPihpbm9kZSkpIHtcclxuICAgICAgdmFyIHN0YXRzID0gaW5vZGUuZ2V0RGF0YSgpO1xyXG4gICAgICBzd2l0Y2ggKGZsYWdzLnBhdGhFeGlzdHNBY3Rpb24oKSkge1xyXG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5USFJPV19FWENFUFRJT046XHJcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLlRSVU5DQVRFX0ZJTEU6XHJcbiAgICAgICAgICB0aHJvdyBBcGlFcnJvci5FRVhJU1QocGF0aCk7XHJcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLk5PUDpcclxuICAgICAgICAgIC8vIFVzZSBleGlzdGluZyBmaWxlIGNvbnRlbnRzLlxyXG4gICAgICAgICAgLy8gWFhYOiBVaCwgdGhpcyBtYWludGFpbnMgdGhlIHByZXZpb3VzbHktdXNlZCBmbGFnLlxyXG4gICAgICAgICAgaWYgKHN0YXRzLmZpbGVfZGF0YSAhPSBudWxsKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBuZXcgcHJlbG9hZF9maWxlLk5vU3luY0ZpbGUodGhpcywgcGF0aCwgZmxhZ3MsIHN0YXRzLmNsb25lKCksIHN0YXRzLmZpbGVfZGF0YSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyBAdG9kbyBiZSBsYXppZXIgYWJvdXQgYWN0dWFsbHkgcmVxdWVzdGluZyB0aGUgZmlsZVxyXG4gICAgICAgICAgdmFyIGJ1ZmZlciA9IHRoaXMuX3JlcXVlc3RGaWxlU3luYyhwYXRoLCAnYnVmZmVyJyk7XHJcbiAgICAgICAgICAvLyB3ZSBkb24ndCBpbml0aWFsbHkgaGF2ZSBmaWxlIHNpemVzXHJcbiAgICAgICAgICBzdGF0cy5zaXplID0gYnVmZmVyLmxlbmd0aDtcclxuICAgICAgICAgIHN0YXRzLmZpbGVfZGF0YSA9IGJ1ZmZlcjtcclxuICAgICAgICAgIHJldHVybiBuZXcgcHJlbG9hZF9maWxlLk5vU3luY0ZpbGUodGhpcywgcGF0aCwgZmxhZ3MsIHN0YXRzLmNsb25lKCksIGJ1ZmZlcik7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCAnSW52YWxpZCBGaWxlTW9kZSBvYmplY3QuJyk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IEFwaUVycm9yLkVJU0RJUihwYXRoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyByZWFkZGlyKHBhdGg6IHN0cmluZywgY2I6IChlOiBBcGlFcnJvciwgbGlzdGluZz86IHN0cmluZ1tdKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0cnkge1xyXG4gICAgICBjYihudWxsLCB0aGlzLnJlYWRkaXJTeW5jKHBhdGgpKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgY2IoZSk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgcmVhZGRpclN5bmMocGF0aDogc3RyaW5nKTogc3RyaW5nW10ge1xyXG4gICAgLy8gQ2hlY2sgaWYgaXQgZXhpc3RzLlxyXG4gICAgdmFyIGlub2RlID0gdGhpcy5faW5kZXguZ2V0SW5vZGUocGF0aCk7XHJcbiAgICBpZiAoaW5vZGUgPT09IG51bGwpIHtcclxuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHBhdGgpO1xyXG4gICAgfSBlbHNlIGlmIChpc0Rpcklub2RlKGlub2RlKSkge1xyXG4gICAgICByZXR1cm4gaW5vZGUuZ2V0TGlzdGluZygpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVERJUihwYXRoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFdlIGhhdmUgdGhlIGVudGlyZSBmaWxlIGFzIGEgYnVmZmVyOyBvcHRpbWl6ZSByZWFkRmlsZS5cclxuICAgKi9cclxuICBwdWJsaWMgcmVhZEZpbGUoZm5hbWU6IHN0cmluZywgZW5jb2Rpbmc6IHN0cmluZywgZmxhZzogRmlsZUZsYWcsIGNiOiAoZXJyOiBBcGlFcnJvciwgZGF0YT86IGFueSkgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgLy8gV3JhcCBjYiBpbiBmaWxlIGNsb3NpbmcgY29kZS5cclxuICAgIHZhciBvbGRDYiA9IGNiO1xyXG4gICAgLy8gR2V0IGZpbGUuXHJcbiAgICB0aGlzLm9wZW4oZm5hbWUsIGZsYWcsIDB4MWE0LCBmdW5jdGlvbihlcnI6IEFwaUVycm9yLCBmZD86IGZpbGUuRmlsZSkge1xyXG4gICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgcmV0dXJuIGNiKGVycik7XHJcbiAgICAgIH1cclxuICAgICAgY2IgPSBmdW5jdGlvbihlcnI6IEFwaUVycm9yLCBhcmc/OiBCdWZmZXIpIHtcclxuICAgICAgICBmZC5jbG9zZShmdW5jdGlvbihlcnIyOiBhbnkpIHtcclxuICAgICAgICAgIGlmIChlcnIgPT0gbnVsbCkge1xyXG4gICAgICAgICAgICBlcnIgPSBlcnIyO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIG9sZENiKGVyciwgYXJnKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfTtcclxuICAgICAgdmFyIGZkQ2FzdCA9IDxwcmVsb2FkX2ZpbGUuTm9TeW5jRmlsZTxYbWxIdHRwUmVxdWVzdD4+IGZkO1xyXG4gICAgICB2YXIgZmRCdWZmID0gPEJ1ZmZlcj4gZmRDYXN0LmdldEJ1ZmZlcigpO1xyXG4gICAgICBpZiAoZW5jb2RpbmcgPT09IG51bGwpIHtcclxuICAgICAgICBjYihlcnIsIGNvcHlpbmdTbGljZShmZEJ1ZmYpKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICB0cnlUb1N0cmluZyhmZEJ1ZmYsIGVuY29kaW5nLCBjYik7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogU3BlY2lhbGx5LW9wdGltaXplZCByZWFkZmlsZS5cclxuICAgKi9cclxuICBwdWJsaWMgcmVhZEZpbGVTeW5jKGZuYW1lOiBzdHJpbmcsIGVuY29kaW5nOiBzdHJpbmcsIGZsYWc6IEZpbGVGbGFnKTogYW55IHtcclxuICAgIC8vIEdldCBmaWxlLlxyXG4gICAgdmFyIGZkID0gdGhpcy5vcGVuU3luYyhmbmFtZSwgZmxhZywgMHgxYTQpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgdmFyIGZkQ2FzdCA9IDxwcmVsb2FkX2ZpbGUuTm9TeW5jRmlsZTxYbWxIdHRwUmVxdWVzdD4+IGZkO1xyXG4gICAgICB2YXIgZmRCdWZmID0gPEJ1ZmZlcj4gZmRDYXN0LmdldEJ1ZmZlcigpO1xyXG4gICAgICBpZiAoZW5jb2RpbmcgPT09IG51bGwpIHtcclxuICAgICAgICByZXR1cm4gY29weWluZ1NsaWNlKGZkQnVmZik7XHJcbiAgICAgIH1cclxuICAgICAgcmV0dXJuIGZkQnVmZi50b1N0cmluZyhlbmNvZGluZyk7XHJcbiAgICB9IGZpbmFsbHkge1xyXG4gICAgICBmZC5jbG9zZVN5bmMoKTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19