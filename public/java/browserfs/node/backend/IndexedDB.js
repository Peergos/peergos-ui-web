"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var kvfs = require('../generic/key_value_filesystem');
var api_error_1 = require('../core/api_error');
var global = require('../core/global');
var util_1 = require('../core/util');
var indexedDB = global.indexedDB ||
    global.mozIndexedDB ||
    global.webkitIndexedDB ||
    global.msIndexedDB;
function convertError(e, message) {
    if (message === void 0) { message = e.toString(); }
    switch (e.name) {
        case "NotFoundError":
            return new api_error_1.ApiError(api_error_1.ErrorCode.ENOENT, message);
        case "QuotaExceededError":
            return new api_error_1.ApiError(api_error_1.ErrorCode.ENOSPC, message);
        default:
            return new api_error_1.ApiError(api_error_1.ErrorCode.EIO, message);
    }
}
function onErrorHandler(cb, code, message) {
    if (code === void 0) { code = api_error_1.ErrorCode.EIO; }
    if (message === void 0) { message = null; }
    return function (e) {
        e.preventDefault();
        cb(new api_error_1.ApiError(code, message));
    };
}
var IndexedDBROTransaction = (function () {
    function IndexedDBROTransaction(tx, store) {
        this.tx = tx;
        this.store = store;
    }
    IndexedDBROTransaction.prototype.get = function (key, cb) {
        try {
            var r = this.store.get(key);
            r.onerror = onErrorHandler(cb);
            r.onsuccess = function (event) {
                var result = event.target.result;
                if (result === undefined) {
                    cb(null, result);
                }
                else {
                    cb(null, util_1.arrayBuffer2Buffer(result));
                }
            };
        }
        catch (e) {
            cb(convertError(e));
        }
    };
    return IndexedDBROTransaction;
}());
exports.IndexedDBROTransaction = IndexedDBROTransaction;
var IndexedDBRWTransaction = (function (_super) {
    __extends(IndexedDBRWTransaction, _super);
    function IndexedDBRWTransaction(tx, store) {
        _super.call(this, tx, store);
    }
    IndexedDBRWTransaction.prototype.put = function (key, data, overwrite, cb) {
        try {
            var arraybuffer = util_1.buffer2ArrayBuffer(data), r;
            if (overwrite) {
                r = this.store.put(arraybuffer, key);
            }
            else {
                r = this.store.add(arraybuffer, key);
            }
            r.onerror = onErrorHandler(cb);
            r.onsuccess = function (event) {
                cb(null, true);
            };
        }
        catch (e) {
            cb(convertError(e));
        }
    };
    IndexedDBRWTransaction.prototype.del = function (key, cb) {
        try {
            var r = this.store['delete'](key);
            r.onerror = onErrorHandler(cb);
            r.onsuccess = function (event) {
                cb();
            };
        }
        catch (e) {
            cb(convertError(e));
        }
    };
    IndexedDBRWTransaction.prototype.commit = function (cb) {
        setTimeout(cb, 0);
    };
    IndexedDBRWTransaction.prototype.abort = function (cb) {
        var _e;
        try {
            this.tx.abort();
        }
        catch (e) {
            _e = convertError(e);
        }
        finally {
            cb(_e);
        }
    };
    return IndexedDBRWTransaction;
}(IndexedDBROTransaction));
exports.IndexedDBRWTransaction = IndexedDBRWTransaction;
var IndexedDBStore = (function () {
    function IndexedDBStore(cb, storeName) {
        var _this = this;
        if (storeName === void 0) { storeName = 'browserfs'; }
        this.storeName = storeName;
        var openReq = indexedDB.open(this.storeName, 1);
        openReq.onupgradeneeded = function (event) {
            var db = event.target.result;
            if (db.objectStoreNames.contains(_this.storeName)) {
                db.deleteObjectStore(_this.storeName);
            }
            db.createObjectStore(_this.storeName);
        };
        openReq.onsuccess = function (event) {
            _this.db = event.target.result;
            cb(null, _this);
        };
        openReq.onerror = onErrorHandler(cb, api_error_1.ErrorCode.EACCES);
    }
    IndexedDBStore.prototype.name = function () {
        return "IndexedDB - " + this.storeName;
    };
    IndexedDBStore.prototype.clear = function (cb) {
        try {
            var tx = this.db.transaction(this.storeName, 'readwrite'), objectStore = tx.objectStore(this.storeName), r = objectStore.clear();
            r.onsuccess = function (event) {
                setTimeout(cb, 0);
            };
            r.onerror = onErrorHandler(cb);
        }
        catch (e) {
            cb(convertError(e));
        }
    };
    IndexedDBStore.prototype.beginTransaction = function (type) {
        if (type === void 0) { type = 'readonly'; }
        var tx = this.db.transaction(this.storeName, type), objectStore = tx.objectStore(this.storeName);
        if (type === 'readwrite') {
            return new IndexedDBRWTransaction(tx, objectStore);
        }
        else if (type === 'readonly') {
            return new IndexedDBROTransaction(tx, objectStore);
        }
        else {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, 'Invalid transaction type.');
        }
    };
    return IndexedDBStore;
}());
exports.IndexedDBStore = IndexedDBStore;
var IndexedDBFileSystem = (function (_super) {
    __extends(IndexedDBFileSystem, _super);
    function IndexedDBFileSystem(cb, storeName) {
        var _this = this;
        _super.call(this);
        new IndexedDBStore(function (e, store) {
            if (e) {
                cb(e);
            }
            else {
                _this.init(store, function (e) {
                    cb(e, _this);
                });
            }
        }, storeName);
    }
    IndexedDBFileSystem.isAvailable = function () {
        try {
            return typeof indexedDB !== 'undefined' && null !== indexedDB.open("__browserfs_test__");
        }
        catch (e) {
            return false;
        }
    };
    return IndexedDBFileSystem;
}(kvfs.AsyncKeyValueFileSystem));
exports.__esModule = true;
exports["default"] = IndexedDBFileSystem;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiSW5kZXhlZERCLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2JhY2tlbmQvSW5kZXhlZERCLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQU8sSUFBSSxXQUFXLGlDQUFpQyxDQUFDLENBQUM7QUFDekQsMEJBQWtDLG1CQUFtQixDQUFDLENBQUE7QUFDdEQsSUFBTyxNQUFNLFdBQVcsZ0JBQWdCLENBQUMsQ0FBQztBQUMxQyxxQkFBcUQsY0FBYyxDQUFDLENBQUE7QUFJcEUsSUFBSSxTQUFTLEdBQWUsTUFBTSxDQUFDLFNBQVM7SUFDWixNQUFPLENBQUMsWUFBWTtJQUNwQixNQUFPLENBQUMsZUFBZTtJQUM3QixNQUFNLENBQUMsV0FBVyxDQUFDO0FBTTdDLHNCQUFzQixDQUFpQixFQUFFLE9BQThCO0lBQTlCLHVCQUE4QixHQUE5QixVQUFrQixDQUFDLENBQUMsUUFBUSxFQUFFO0lBQ3JFLE1BQU0sQ0FBQSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ2QsS0FBSyxlQUFlO1lBQ2xCLE1BQU0sQ0FBQyxJQUFJLG9CQUFRLENBQUMscUJBQVMsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLENBQUM7UUFDakQsS0FBSyxvQkFBb0I7WUFDdkIsTUFBTSxDQUFDLElBQUksb0JBQVEsQ0FBQyxxQkFBUyxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztRQUNqRDtZQUVFLE1BQU0sQ0FBQyxJQUFJLG9CQUFRLENBQUMscUJBQVMsQ0FBQyxHQUFHLEVBQUUsT0FBTyxDQUFDLENBQUM7SUFDaEQsQ0FBQztBQUNILENBQUM7QUFPRCx3QkFBd0IsRUFBeUIsRUFDL0MsSUFBK0IsRUFBRSxPQUFzQjtJQUF2RCxvQkFBK0IsR0FBL0IsT0FBa0IscUJBQVMsQ0FBQyxHQUFHO0lBQUUsdUJBQXNCLEdBQXRCLGNBQXNCO0lBQ3ZELE1BQU0sQ0FBQyxVQUFVLENBQU87UUFFdEIsQ0FBQyxDQUFD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QyxDQUFDLEVBQUUsS0FBSSxDQUFDLENBQUM7Z0JBQ2QsQ0FBQyxDQUFDLENBQUM7WUFDTCxDQUFDO1FBQ0gsQ0FBQyxFQUFFLFNBQVMsQ0FBQyxDQUFDO0lBQ2hCLENBQUM7SUFFYSwrQkFBVyxHQUF6QjtRQUtFLElBQUksQ0FBQztZQUNILE1BQU0sQ0FBQyxPQUFPLFNBQVMsS0FBSyxXQUFXLElBQUksSUFBSSxLQUFLLFNBQVMsQ0FBQyxJQUFJLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUMzRixDQUFFO1FBQUEsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNYLE1BQU0sQ0FBQyxLQUFLLENBQUM7UUFDZixDQUFDO0lBQ0gsQ0FBQztJQUNILDBCQUFDO0FBQUQsQ0FBQyxBQXpCRCxDQUFpRCxJQUFJLENBQUMsdUJBQXVCLEdBeUI1RTtBQXpCRDt3Q0F5QkMsQ0FBQSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBrdmZzID0gcmVxdWlyZSgnLi4vZ2VuZXJpYy9rZXlfdmFsdWVfZmlsZXN5c3RlbScpO1xyXG5pbXBvcnQge0FwaUVycm9yLCBFcnJvckNvZGV9IGZyb20gJy4uL2NvcmUvYXBpX2Vycm9yJztcclxuaW1wb3J0IGdsb2JhbCA9IHJlcXVpcmUoJy4uL2NvcmUvZ2xvYmFsJyk7XHJcbmltcG9ydCB7YXJyYXlCdWZmZXIyQnVmZmVyLCBidWZmZXIyQXJyYXlCdWZmZXJ9IGZyb20gJy4uL2NvcmUvdXRpbCc7XHJcbi8qKlxyXG4gKiBHZXQgdGhlIGluZGV4ZWREQiBjb25zdHJ1Y3RvciBmb3IgdGhlIGN1cnJlbnQgYnJvd3Nlci5cclxuICovXHJcbnZhciBpbmRleGVkREI6IElEQkZhY3RvcnkgPSBnbG9iYWwuaW5kZXhlZERCIHx8XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgKDxhbnk+Z2xvYmFsKS5tb3pJbmRleGVkREIgfHxcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAoPGFueT5nbG9iYWwpLndlYmtpdEluZGV4ZWREQiB8fFxyXG4gICAgICAgICAgICAgICAgICAgICAgICAgIGdsb2JhbC5tc0luZGV4ZWREQjtcclxuXHJcbi8qKlxyXG4gKiBDb252ZXJ0cyBhIERPTUV4Y2VwdGlvbiBvciBhIERPTUVycm9yIGZyb20gYW4gSW5kZXhlZERCIGV2ZW50IGludG8gYVxyXG4gKiBzdGFuZGFyZGl6ZWQgQnJvd3NlckZTIEFQSSBlcnJvci5cclxuICovXHJcbmZ1bmN0aW9uIGNvbnZlcnRFcnJvcihlOiB7bmFtZTogc3RyaW5nfSwgbWVzc2FnZTogc3RyaW5nID0gZS50b1N0cmluZygpKTogQXBpRXJyb3Ige1xyXG4gIHN3aXRjaChlLm5hbWUpIHtcclxuICAgIGNhc2UgXCJOb3RGb3VuZEVycm9yXCI6XHJcbiAgICAgIHJldHVybiBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVOT0VOVCwgbWVzc2FnZSk7XHJcbiAgICBjYXNlIFwiUXVvdGFFeGNlZWRlZEVycm9yXCI6XHJcbiAgICAgIHJldHVybiBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVOT1NQQywgbWVzc2FnZSk7XHJcbiAgICBkZWZhdWx0OlxyXG4gICAgICAvLyBUaGUgcmVzdCBkbyBub3Qgc2VlbSB0byBtYXAgY2xlYW5seSB0byBzdGFuZGFyZCBlcnJvciBjb2Rlcy5cclxuICAgICAgcmV0dXJuIG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlPLCBtZXNzYWdlKTtcclxuICB9XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBQcm9kdWNlcyBhIG5ldyBvbmVycm9yIGhhbmRsZXIgZm9yIElEQi4gT3VyIGVycm9ycyBhcmUgYWx3YXlzIGZhdGFsLCBzbyB3ZVxyXG4gKiBoYW5kbGUgdGhlbSBnZW5lcmljYWxseTogQ2FsbCB0aGUgdXNlci1zdXBwbGllZCBjYWxsYmFjayB3aXRoIGEgdHJhbnNsYXRlZFxyXG4gKiB2ZXJzaW9uIG9mIHRoZSBlcnJvciwgYW5kIGxldCB0aGUgZXJyb3IgYnViYmxlIHVwLlxyXG4gKi9cclxuZnVuY3Rpb24gb25FcnJvckhhbmRsZXIoY2I6IChlOiBBcGlFcnJvcikgPT4gdm9pZCxcclxuICBjb2RlOiBFcnJvckNvZGUgPSBFcnJvckNvZGUuRUlPLCBtZXNzYWdlOiBzdHJpbmcgPSBudWxsKTogKGU/OiBhbnkpID0+IHZvaWQge1xyXG4gIHJldHVybiBmdW5jdGlvbiAoZT86IGFueSk6IHZvaWQge1xyXG4gICAgLy8gUHJldmVudCB0aGUgZXJyb3IgZnJvbSBjYW5jZWxpbmcgdGhlIHRyYW5zYWN0aW9uLlxyXG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgY2IobmV3IEFwaUVycm9yKGNvZGUsIG1lc3NhZ2UpKTtcclxuICB9O1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSW5kZXhlZERCUk9UcmFuc2FjdGlvbiBpbXBsZW1lbnRzIGt2ZnMuQXN5bmNLZXlWYWx1ZVJPVHJhbnNhY3Rpb24ge1xyXG4gIGNvbnN0cnVjdG9yKHB1YmxpYyB0eDogSURCVHJhbnNhY3Rpb24sIHB1YmxpYyBzdG9yZTogSURCT2JqZWN0U3RvcmUpIHsgfVxyXG5cclxuICBnZXQoa2V5OiBzdHJpbmcsIGNiOiAoZTogQXBpRXJyb3IsIGRhdGE/OiBOb2RlQnVmZmVyKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0cnkge1xyXG4gICAgICB2YXIgcjogSURCUmVxdWVzdCA9IHRoaXMuc3RvcmUuZ2V0KGtleSk7XHJcbiAgICAgIHIub25lcnJvciA9IG9uRXJyb3JIYW5kbGVyKGNiKTtcclxuICAgICAgci5vbnN1Y2Nlc3MgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICAvLyBJREIgcmV0dXJucyB0aGUgdmFsdWUgJ3VuZGVmaW5lZCcgd2hlbiB5b3UgdHJ5IHRvIGdldCBrZXlzIHRoYXRcclxuICAgICAgICAvLyBkb24ndCBleGlzdC4gVGhlIGNhbGxlciBleHBlY3RzIHRoaXMgYmVoYXZpb3IuXHJcbiAgICAgICAgdmFyIHJlc3VsdDogYW55ID0gKDxhbnk+ZXZlbnQudGFyZ2V0KS5yZXN1bHQ7XHJcbiAgICAgICAgaWYgKHJlc3VsdCA9PT0gdW5kZWZpbmVkKSB7XHJcbiAgICAgICAgICBjYihudWxsLCByZXN1bHQpO1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAvLyBJREIgZGF0YSBpcyBzdG9yZWQgYXMgYW4gQXJyYXlCdWZmZXJcclxuICAgICAgICAgIGNiKG51bGwsIGFycmF5QnVmZmVyMkJ1ZmZlcihyZXN1bHQpKTtcclxuICAgICAgICB9XHJcbiAgICAgIH07XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIGNiKGNvbnZlcnRFcnJvcihlKSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSW5kZXhlZERCUldUcmFuc2FjdGlvbiBleHRlbmRzIEluZGV4ZWREQlJPVHJhbnNhY3Rpb24gaW1wbGVtZW50cyBrdmZzLkFzeW5jS2V5VmFsdWVSV1RyYW5zYWN0aW9uLCBrdmZzLkFzeW5jS2V5VmFsdWVST1RyYW5zYWN0aW9uIHtcclxuICBjb25zdHJ1Y3Rvcih0eDogSURCVHJhbnNhY3Rpb24sIHN0b3JlOiBJREJPYmplY3RTdG9yZSkge1xyXG4gICAgc3VwZXIodHgsIHN0b3JlKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBwdXQoa2V5OiBzdHJpbmcsIGRhdGE6IE5vZGVCdWZmZXIsIG92ZXJ3cml0ZTogYm9vbGVhbiwgY2I6IChlOiBBcGlFcnJvciwgY29tbWl0dGVkPzogYm9vbGVhbikgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdHJ5IHtcclxuICAgICAgdmFyIGFycmF5YnVmZmVyID0gYnVmZmVyMkFycmF5QnVmZmVyKGRhdGEpLFxyXG4gICAgICAgIHI6IElEQlJlcXVlc3Q7XHJcbiAgICAgIGlmIChvdmVyd3JpdGUpIHtcclxuICAgICAgICByID0gdGhpcy5zdG9yZS5wdXQoYXJyYXlidWZmZXIsIGtleSk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gJ2FkZCcgd2lsbCBuZXZlciBvdmVyd3JpdGUgYW4gZXhpc3Rpbmcga2V5LlxyXG4gICAgICAgIHIgPSB0aGlzLnN0b3JlLmFkZChhcnJheWJ1ZmZlciwga2V5KTtcclxuICAgICAgfVxyXG4gICAgICAvLyBYWFg6IE5FRUQgVE8gUkVUVVJOIEZBTFNFIFdIRU4gQUREIEhBUyBBIEtFWSBDT05GTElDVC4gTk8gRVJST1IuXHJcbiAgICAgIHIub25lcnJvciA9IG9uRXJyb3JIYW5kbGVyKGNiKTtcclxuICAgICAgci5vbnN1Y2Nlc3MgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICBjYihudWxsLCB0cnVlKTtcclxuICAgICAgfTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgY2IoY29udmVydEVycm9yKGUpKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyBkZWwoa2V5OiBzdHJpbmcsIGNiOiAoZT86IEFwaUVycm9yKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICB0cnkge1xyXG4gICAgICAvLyBOT1RFOiBJRTggaGFzIGEgYnVnIHdpdGggaWRlbnRpZmllcnMgbmFtZWQgJ2RlbGV0ZScgdW5sZXNzIHVzZWQgYXMgYSBzdHJpbmdcclxuICAgICAgLy8gbGlrZSB0aGlzLlxyXG4gICAgICAvLyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8yNjQ3OTE1MlxyXG4gICAgICB2YXIgcjogSURCUmVxdWVzdCA9IHRoaXMuc3RvcmVbJ2RlbGV0ZSddKGtleSk7XHJcbiAgICAgIHIub25lcnJvciA9IG9uRXJyb3JIYW5kbGVyKGNiKTtcclxuICAgICAgci5vbnN1Y2Nlc3MgPSAoZXZlbnQpID0+IHtcclxuICAgICAgICBjYigpO1xyXG4gICAgICB9O1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBjYihjb252ZXJ0RXJyb3IoZSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGNvbW1pdChjYjogKGU/OiBBcGlFcnJvcikgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgLy8gUmV0dXJuIHRvIHRoZSBldmVudCBsb29wIHRvIGNvbW1pdCB0aGUgdHJhbnNhY3Rpb24uXHJcbiAgICBzZXRUaW1lb3V0KGNiLCAwKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBhYm9ydChjYjogKGU/OiBBcGlFcnJvcikgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdmFyIF9lOiBBcGlFcnJvcjtcclxuICAgIHRyeSB7XHJcbiAgICAgIHRoaXMudHguYWJvcnQoKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgX2UgPSBjb252ZXJ0RXJyb3IoZSk7XHJcbiAgICB9IGZpbmFsbHkge1xyXG4gICAgICBjYihfZSk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgSW5kZXhlZERCU3RvcmUgaW1wbGVtZW50cyBrdmZzLkFzeW5jS2V5VmFsdWVTdG9yZSB7XHJcbiAgcHJpdmF0ZSBkYjogSURCRGF0YWJhc2U7XHJcblxyXG4gIC8qKlxyXG4gICAqIENvbnN0cnVjdHMgYW4gSW5kZXhlZERCIGZpbGUgc3lzdGVtLlxyXG4gICAqIEBwYXJhbSBjYiBDYWxsZWQgb25jZSB0aGUgZGF0YWJhc2UgaXMgaW5zdGFudGlhdGVkIGFuZCByZWFkeSBmb3IgdXNlLlxyXG4gICAqICAgUGFzc2VzIGFuIGVycm9yIGlmIHRoZXJlIHdhcyBhbiBpc3N1ZSBpbnN0YW50aWF0aW5nIHRoZSBkYXRhYmFzZS5cclxuICAgKiBAcGFyYW0gb2JqZWN0U3RvcmVOYW1lIFRoZSBuYW1lIG9mIHRoaXMgZmlsZSBzeXN0ZW0uIFlvdSBjYW4gaGF2ZVxyXG4gICAqICAgbXVsdGlwbGUgSW5kZXhlZERCIGZpbGUgc3lzdGVtcyBvcGVyYXRpbmcgYXQgb25jZSwgYnV0IGVhY2ggbXVzdCBoYXZlXHJcbiAgICogICBhIGRpZmZlcmVudCBuYW1lLlxyXG4gICAqL1xyXG4gIGNvbnN0cnVjdG9yKGNiOiAoZTogQXBpRXJyb3IsIHN0b3JlPzogSW5kZXhlZERCU3RvcmUpID0+IHZvaWQsIHByaXZhdGUgc3RvcmVOYW1lOiBzdHJpbmcgPSAnYnJvd3NlcmZzJykge1xyXG4gICAgdmFyIG9wZW5SZXE6IElEQk9wZW5EQlJlcXVlc3QgPSBpbmRleGVkREIub3Blbih0aGlzLnN0b3JlTmFtZSwgMSk7XHJcblxyXG4gICAgb3BlblJlcS5vbnVwZ3JhZGVuZWVkZWQgPSAoZXZlbnQpID0+IHtcclxuICAgICAgdmFyIGRiOiBJREJEYXRhYmFzZSA9ICg8YW55PmV2ZW50LnRhcmdldCkucmVzdWx0O1xyXG4gICAgICAvLyBIdWguIFRoaXMgc2hvdWxkIG5ldmVyIGhhcHBlbjsgd2UncmUgYXQgdmVyc2lvbiAxLiBXaHkgZG9lcyBhbm90aGVyXHJcbiAgICAgIC8vIGRhdGFiYXNlIGV4aXN0P1xyXG4gICAgICBpZiAoZGIub2JqZWN0U3RvcmVOYW1lcy5jb250YWlucyh0aGlzLnN0b3JlTmFtZSkpIHtcclxuICAgICAgICBkYi5kZWxldGVPYmplY3RTdG9yZSh0aGlzLnN0b3JlTmFtZSk7XHJcbiAgICAgIH1cclxuICAgICAgZGIuY3JlYXRlT2JqZWN0U3RvcmUodGhpcy5zdG9yZU5hbWUpO1xyXG4gICAgfTtcclxuXHJcbiAgICBvcGVuUmVxLm9uc3VjY2VzcyA9IChldmVudCkgPT4ge1xyXG4gICAgICB0aGlzLmRiID0gKDxhbnk+ZXZlbnQudGFyZ2V0KS5yZXN1bHQ7XHJcbiAgICAgIGNiKG51bGwsIHRoaXMpO1xyXG4gICAgfTtcclxuXHJcbiAgICBvcGVuUmVxLm9uZXJyb3IgPSBvbkVycm9ySGFuZGxlcihjYiwgRXJyb3JDb2RlLkVBQ0NFUyk7XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgbmFtZSgpOiBzdHJpbmcge1xyXG4gICAgcmV0dXJuIFwiSW5kZXhlZERCIC0gXCIgKyB0aGlzLnN0b3JlTmFtZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBjbGVhcihjYjogKGU/OiBBcGlFcnJvcikgPT4gdm9pZCk6IHZvaWQge1xyXG4gICAgdHJ5IHtcclxuICAgICAgdmFyIHR4ID0gdGhpcy5kYi50cmFuc2FjdGlvbih0aGlzLnN0b3JlTmFtZSwgJ3JlYWR3cml0ZScpLFxyXG4gICAgICAgIG9iamVjdFN0b3JlID0gdHgub2JqZWN0U3RvcmUodGhpcy5zdG9yZU5hbWUpLFxyXG4gICAgICAgIHI6IElEQlJlcXVlc3QgPSBvYmplY3RTdG9yZS5jbGVhcigpO1xyXG4gICAgICByLm9uc3VjY2VzcyA9IChldmVudCkgPT4ge1xyXG4gICAgICAgIC8vIFVzZSBzZXRUaW1lb3V0IHRvIGNvbW1pdCB0cmFuc2FjdGlvbi5cclxuICAgICAgICBzZXRUaW1lb3V0KGNiLCAwKTtcclxuICAgICAgfTtcclxuICAgICAgci5vbmVycm9yID0gb25FcnJvckhhbmRsZXIoY2IpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBjYihjb252ZXJ0RXJyb3IoZSkpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGJlZ2luVHJhbnNhY3Rpb24odHlwZTogc3RyaW5nID0gJ3JlYWRvbmx5Jyk6IGt2ZnMuQXN5bmNLZXlWYWx1ZVJPVHJhbnNhY3Rpb24ge1xyXG4gICAgdmFyIHR4ID0gdGhpcy5kYi50cmFuc2FjdGlvbih0aGlzLnN0b3JlTmFtZSwgdHlwZSksXHJcbiAgICAgIG9iamVjdFN0b3JlID0gdHgub2JqZWN0U3RvcmUodGhpcy5zdG9yZU5hbWUpO1xyXG4gICAgaWYgKHR5cGUgPT09ICdyZWFkd3JpdGUnKSB7XHJcbiAgICAgIHJldHVybiBuZXcgSW5kZXhlZERCUldUcmFuc2FjdGlvbih0eCwgb2JqZWN0U3RvcmUpO1xyXG4gICAgfSBlbHNlIGlmICh0eXBlID09PSAncmVhZG9ubHknKSB7XHJcbiAgICAgIHJldHVybiBuZXcgSW5kZXhlZERCUk9UcmFuc2FjdGlvbih0eCwgb2JqZWN0U3RvcmUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgbmV3IEFwaUVycm9yKEVycm9yQ29kZS5FSU5WQUwsICdJbnZhbGlkIHRyYW5zYWN0aW9uIHR5cGUuJyk7XHJcbiAgICB9XHJcbiAgfVxyXG59XHJcblxyXG4vKipcclxuICogQSBmaWxlIHN5c3RlbSB0aGF0IHVzZXMgdGhlIEluZGV4ZWREQiBrZXkgdmFsdWUgZmlsZSBzeXN0ZW0uXHJcbiAqL1xyXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBJbmRleGVkREJGaWxlU3lzdGVtIGV4dGVuZHMga3Zmcy5Bc3luY0tleVZhbHVlRmlsZVN5c3RlbSB7XHJcbiAgY29uc3RydWN0b3IoY2I6IChlOiBBcGlFcnJvciwgZnM/OiBJbmRleGVkREJGaWxlU3lzdGVtKSA9PiB2b2lkLCBzdG9yZU5hbWU/OiBzdHJpbmcpIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICBuZXcgSW5kZXhlZERCU3RvcmUoKGUsIHN0b3JlPyk6IHZvaWQgPT4ge1xyXG4gICAgICBpZiAoZSkge1xyXG4gICAgICAgIGNiKGUpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuaW5pdChzdG9yZSwgKGU/KSA9PiB7XHJcbiAgICAgICAgICBjYihlLCB0aGlzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfVxyXG4gICAgfSwgc3RvcmVOYW1lKTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XHJcbiAgICAvLyBJbiBTYWZhcmkncyBwcml2YXRlIGJyb3dzaW5nIG1vZGUsIGluZGV4ZWREQi5vcGVuIHJldHVybnMgTlVMTC5cclxuICAgIC8vIEluIEZpcmVmb3gsIGl0IHRocm93cyBhbiBleGNlcHRpb24uXHJcbiAgICAvLyBJbiBDaHJvbWUsIGl0IFwianVzdCB3b3Jrc1wiLCBhbmQgY2xlYXJzIHRoZSBkYXRhYmFzZSB3aGVuIHlvdSBsZWF2ZSB0aGUgcGFnZS5cclxuICAgIC8vIFVudGVzdGVkOiBPcGVyYSwgSUUuXHJcbiAgICB0cnkge1xyXG4gICAgICByZXR1cm4gdHlwZW9mIGluZGV4ZWREQiAhPT0gJ3VuZGVmaW5lZCcgJiYgbnVsbCAhPT0gaW5kZXhlZERCLm9wZW4oXCJfX2Jyb3dzZXJmc190ZXN0X19cIik7XHJcbiAgICB9IGNhdGNoIChlKSB7XHJcbiAgICAgIHJldHVybiBmYWxzZTtcclxuICAgIH1cclxuICB9XHJcbn1cclxuIl19