"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system = require('../core/file_system');
var api_error_1 = require('../core/api_error');
var file_flag_1 = require('../core/file_flag');
var preload_file = require('../generic/preload_file');
var path = require('path');
var deletionLogPath = '/.deletedFiles.log';
function makeModeWritable(mode) {
    return 0x92 | mode;
}
var OverlayFile = (function (_super) {
    __extends(OverlayFile, _super);
    function OverlayFile(fs, path, flag, stats, data) {
        _super.call(this, fs, path, flag, stats, data);
    }
    OverlayFile.prototype.syncSync = function () {
        if (this.isDirty()) {
            this._fs._syncSync(this);
            this.resetDirty();
        }
    };
    OverlayFile.prototype.closeSync = function () {
        this.syncSync();
    };
    return OverlayFile;
}(preload_file.PreloadFile));
var OverlayFS = (function (_super) {
    __extends(OverlayFS, _super);
    function OverlayFS(writable, readable) {
        _super.call(this);
        this._isInitialized = false;
        this._initializeCallbacks = [];
        this._deletedFiles = {};
        this._deleteLog = null;
        this._writable = writable;
        this._readable = readable;
        if (this._writable.isReadOnly()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "Writable file system must be writable.");
        }
        if (!this._writable.supportsSynch() || !this._readable.supportsSynch()) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EINVAL, "OverlayFS currently only operates on synchronous file systems.");
        }
    }
    OverlayFS.prototype.checkInitialized = function () {
        if (!this._isInitialized) {
            throw new api_error_1.ApiError(api_error_1.ErrorCode.EPERM, "OverlayFS is not initialized. Please initialize OverlayFS using its initialize() method before using it.");
        }
    };
    OverlayFS.prototype.getOverlayedFileSystems = function () {
        return {
            readable: this._readable,
            writable: this._writable
        };
    };
    OverlayFS.prototype.createParentDirectories = function (p) {
        var _this = this;
        var parent = path.dirname(p), toCreate = [];
        while (!this._writable.existsSync(parent)) {
            toCreate.push(parent);
            parent = path.dirname(parent);
        }
        toCreate = toCreate.reverse();
        toCreate.forEach(function (p) {
            _this._writable.mkdirSync(p, _this.statSync(p, false).mode);
        });
    };
    OverlayFS.isAvailable = function () {
        return true;
    };
    OverlayFS.prototype._syncSync = function (file) {
        this.createParentDirectories(file.getPath());
        this._writable.writeFileSync(file.getPath(), file.getBuffer(), null, file_flag_1.FileFlag.getFileFlag('w'), file.getStats().mode);
    };
    OverlayFS.prototype.getName = function () {
        return "OverlayFS";
    };
    OverlayFS.prototype.initialize = function (cb) {
        var _this = this;
        var callbackArray = this._initializeCallbacks;
        var end = function (e) {
            _this._isInitialized = !e;
            _this._initializeCallbacks = [];
            callbackArray.forEach((function (cb) { return cb(e); }));
        };
        if (!this._isInitialized) {
            if (callbackArray.push(cb) === 1) {
                this._writable.readFile(deletionLogPath, 'utf8', file_flag_1.FileFlag.getFileFlag('r'), function (err, data) {
                    if (err) {
                        if (err.errno !== api_error_1.ErrorCode.ENOENT) {
                            return end(err);
                        }
                    }
                    else {
                        data.split('\n').forEach(function (path) {
                            _this._deletedFiles[path.slice(1)] = path.slice(0, 1) === 'd';
                        });
                    }
                    _this._writable.open(deletionLogPath, file_flag_1.FileFlag.getFileFlag('a'), 0x1a4, function (err, fd) {
                        if (err) {
                            end(err);
                        }
                        else {
                            _this._deleteLog = fd;
                            end();
                        }
                    });
                });
            }
        }
        else {
            cb();
        }
    };
    OverlayFS.prototype.isReadOnly = function () { return false; };
    OverlayFS.prototype.supportsSynch = function () { return true; };
    OverlayFS.prototype.supportsLinks = function () { return false; };
    OverlayFS.prototype.supportsProps = function () { return this._readable.supportsProps() && this._writable.supportsProps(); };
    OverlayFS.prototype.deletePath = function (p) {
        this._deletedFiles[p] = true;
        var buff = new Buffer("d" + p + "\n");
        this._deleteLog.writeSync(buff, 0, buff.length, null);
        this._deleteLog.syncSync();
    };
    OverlayFS.prototype.undeletePath = function (p) {
        if (this._deletedFiles[p]) {
            this._deletedFiles[p] = false;
            var buff = new Buffer("u" + p);
            this._deleteLog.writeSync(buff, 0, buff.length, null);
            this._deleteLog.syncSync();
        }
    };
    OverlayFS.prototype.renameSync = function (oldPath, newPath) {
        var _this = this;
        this.checkInitialized();
        var oldStats = this.statSync(oldPath, false);
        if (oldStats.isDirectory()) {
            if (oldPath === newPath) {
                return;
            }
            var mode = 0x1ff;
            if (this.existsSync(newPath)) {
                var stats = this.statSync(newPath, false), mode = stats.mode;
                if (stats.isDirectory()) {
                    if (this.readdirSync(newPath).length > 0) {
                        throw api_error_1.ApiError.ENOTEMPTY(newPath);
                    }
                }
                else {
                    throw api_error_1.ApiError.ENOTDIR(newPath);
                }
            }
            if (this._writable.existsSync(oldPath)) {
                this._writable.renameSync(oldPath, newPath);
            }
            else if (!this._writable.existsSync(newPath)) {
                this._writable.mkdirSync(newPath, mode);
            }
            if (this._readable.existsSync(oldPath)) {
                this._readable.readdirSync(oldPath).forEach(function (name) {
                    _this.renameSync(path.resolve(oldPath, name), path.resolve(newPath, name));
                });
            }
        }
        else {
            if (this.existsSync(newPath) && this.statSync(newPath, false).isDirectory()) {
                throw api_error_1.ApiError.EISDIR(newPath);
            }
            this.writeFileSync(newPath, this.readFileSync(oldPath, null, file_flag_1.FileFlag.getFileFlag('r')), null, file_flag_1.FileFlag.getFileFlag('w'), oldStats.mode);
        }
        if (oldPath !== newPath && this.existsSync(oldPath)) {
            this.unlinkSync(oldPath);
        }
    };
    OverlayFS.prototype.statSync = function (p, isLstat) {
        this.checkInitialized();
        try {
            return this._writable.statSync(p, isLstat);
        }
        catch (e) {
            if (this._deletedFiles[p]) {
                throw api_error_1.ApiError.ENOENT(p);
            }
            var oldStat = this._readable.statSync(p, isLstat).clone();
            oldStat.mode = makeModeWritable(oldStat.mode);
            return oldStat;
        }
    };
    OverlayFS.prototype.openSync = function (p, flag, mode) {
        this.checkInitialized();
        if (this.existsSync(p)) {
            switch (flag.pathExistsAction()) {
                case file_flag_1.ActionType.TRUNCATE_FILE:
                    this.createParentDirectories(p);
                    return this._writable.openSync(p, flag, mode);
                case file_flag_1.ActionType.NOP:
                    if (this._writable.existsSync(p)) {
                        return this._writable.openSync(p, flag, mode);
                    }
                    else {
                        var stats = this._readable.statSync(p, false).clone();
                        stats.mode = mode;
                        return new OverlayFile(this, p, flag, stats, this._readable.readFileSync(p, null, file_flag_1.FileFlag.getFileFlag('r')));
                    }
                default:
                    throw api_error_1.ApiError.EEXIST(p);
            }
        }
        else {
            switch (flag.pathNotExistsAction()) {
                case file_flag_1.ActionType.CREATE_FILE:
                    this.createParentDirectories(p);
                    return this._writable.openSync(p, flag, mode);
                default:
                    throw api_error_1.ApiError.ENOENT(p);
            }
        }
    };
    OverlayFS.prototype.unlinkSync = function (p) {
        this.checkInitialized();
        if (this.existsSync(p)) {
            if (this._writable.existsSync(p)) {
                this._writable.unlinkSync(p);
            }
            if (this.existsSync(p)) {
                this.deletePath(p);
            }
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.rmdirSync = function (p) {
        this.checkInitialized();
        if (this.existsSync(p)) {
            if (this._writable.existsSync(p)) {
                this._writable.rmdirSync(p);
            }
            if (this.existsSync(p)) {
                if (this.readdirSync(p).length > 0) {
                    throw api_error_1.ApiError.ENOTEMPTY(p);
                }
                else {
                    this.deletePath(p);
                }
            }
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.mkdirSync = function (p, mode) {
        this.checkInitialized();
        if (this.existsSync(p)) {
            throw api_error_1.ApiError.EEXIST(p);
        }
        else {
            this.createParentDirectories(p);
            this._writable.mkdirSync(p, mode);
        }
    };
    OverlayFS.prototype.readdirSync = function (p) {
        var _this = this;
        this.checkInitialized();
        var dirStats = this.statSync(p, false);
        if (!dirStats.isDirectory()) {
            throw api_error_1.ApiError.ENOTDIR(p);
        }
        var contents = [];
        try {
            contents = contents.concat(this._writable.readdirSync(p));
        }
        catch (e) {
        }
        try {
            contents = contents.concat(this._readable.readdirSync(p));
        }
        catch (e) {
        }
        var seenMap = {};
        return contents.filter(function (fileP) {
            var result = seenMap[fileP] === undefined && _this._deletedFiles[p + "/" + fileP] !== true;
            seenMap[fileP] = true;
            return result;
        });
    };
    OverlayFS.prototype.existsSync = function (p) {
        this.checkInitialized();
        return this._writable.existsSync(p) || (this._readable.existsSync(p) && this._deletedFiles[p] !== true);
    };
    OverlayFS.prototype.chmodSync = function (p, isLchmod, mode) {
        var _this = this;
        this.checkInitialized();
        this.operateOnWritable(p, function () {
            _this._writable.chmodSync(p, isLchmod, mode);
        });
    };
    OverlayFS.prototype.chownSync = function (p, isLchown, uid, gid) {
        var _this = this;
        this.checkInitialized();
        this.operateOnWritable(p, function () {
            _this._writable.chownSync(p, isLchown, uid, gid);
        });
    };
    OverlayFS.prototype.utimesSync = function (p, atime, mtime) {
        var _this = this;
        this.checkInitialized();
        this.operateOnWritable(p, function () {
            _this._writable.utimesSync(p, atime, mtime);
        });
    };
    OverlayFS.prototype.operateOnWritable = function (p, f) {
        if (this.existsSync(p)) {
            if (!this._writable.existsSync(p)) {
                this.copyToWritable(p);
            }
            f();
        }
        else {
            throw api_error_1.ApiError.ENOENT(p);
        }
    };
    OverlayFS.prototype.copyToWritable = function (p) {
        var pStats = this.statSync(p, false);
        if (pStats.isDirectory()) {
            this._writable.mkdirSync(p, pStats.mode);
        }
        else {
            this.writeFileSync(p, this._readable.readFileSync(p, null, file_flag_1.FileFlag.getFileFlag('r')), null, file_flag_1.FileFlag.getFileFlag('w'), this.statSync(p, false).mode);
        }
    };
    return OverlayFS;
}(file_system.SynchronousFileSystem));
exports.__esModule = true;
exports["default"] = OverlayFS;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiT3ZlcmxheUZTLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc3JjL2JhY2tlbmQvT3ZlcmxheUZTLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7OztBQUFBLElBQU8sV0FBVyxXQUFXLHFCQUFxQixDQUFDLENBQUM7QUFDcEQsMEJBQWtDLG1CQUFtQixDQUFDLENBQUE7QUFDdEQsMEJBQW1DLG1CQUFtQixDQUFDLENBQUE7QUFJdkQsSUFBTyxZQUFZLFdBQVcseUJBQXlCLENBQUMsQ0FBQztBQUN6RCxJQUFPLElBQUksV0FBVyxNQUFNLENBQUMsQ0FBQztBQUM5QixJQUFJLGVBQWUsR0FBRyxvQkFBb0IsQ0FBQztBQUszQywwQkFBMEIsSUFBWTtJQUNwQyxNQUFNLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztBQUNyQixDQUFDO0FBS0Q7SUFBMEIsK0JBQW1DO0lBQzNELHFCQUFZLEVBQWEsRUFBRSxJQUFZLEVBQUUsSUFBYyxFQUFFLEtBQVksRUFBRSxJQUFZO1FBQ2pGLGtCQUFNLEVBQUUsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBRU0sOEJBQVEsR0FBZjtRQUNFLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDbkIsSUFBSSxDQUFDLEdBQUcsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDekIsSUFBSSxDQUFDLFVBQVUsRUFBRSxDQUFDO1FBQ3BCLENBQUM7SUFDSCxDQUFDO0lBRU0sK0JBQVMsR0FBaEI7UUFDRSxJQUFJLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDbEIsQ0FBQztJQUNILGtCQUFDO0FBQUQsQ0FBQyxBQWZELENBQTBCLFlBQVksQ0FBQyxXQUFXLEdBZWpEO0FBU0Q7SUFBdUMsNkJBQWlDO0lBUXRFLG1CQUFZLFFBQWdDLEVBQUUsUUFBZ0M7UUFDNUUsaUJBQU8sQ0FBQztR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QUFDLENBQUMsRUFDbEIsSUFBSSxDQUFDLFNBQVMsQ0FBQyxZQUFZLENBQUMsQ0FBQyxFQUFFLElBQUksRUFBRSxvQkFBUSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLElBQUksRUFDckUsb0JBQVEsQ0FBQyxXQUFXLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDN0QsQ0FBQztJQUNILENBQUM7SUFDSCxnQkFBQztBQUFELENBQUMsQUFqV0QsQ0FBdUMsV0FBVyxDQUFDLHFCQUFxQixHQWlXdkU7QUFqV0Q7OEJBaVdDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZmlsZV9zeXN0ZW0gPSByZXF1aXJlKCcuLi9jb3JlL2ZpbGVfc3lzdGVtJyk7XHJcbmltcG9ydCB7QXBpRXJyb3IsIEVycm9yQ29kZX0gZnJvbSAnLi4vY29yZS9hcGlfZXJyb3InO1xyXG5pbXBvcnQge0ZpbGVGbGFnLCBBY3Rpb25UeXBlfSBmcm9tICcuLi9jb3JlL2ZpbGVfZmxhZyc7XHJcbmltcG9ydCB1dGlsID0gcmVxdWlyZSgnLi4vY29yZS91dGlsJyk7XHJcbmltcG9ydCBmaWxlID0gcmVxdWlyZSgnLi4vY29yZS9maWxlJyk7XHJcbmltcG9ydCBTdGF0cyBmcm9tICcuLi9jb3JlL25vZGVfZnNfc3RhdHMnO1xyXG5pbXBvcnQgcHJlbG9hZF9maWxlID0gcmVxdWlyZSgnLi4vZ2VuZXJpYy9wcmVsb2FkX2ZpbGUnKTtcclxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmxldCBkZWxldGlvbkxvZ1BhdGggPSAnLy5kZWxldGVkRmlsZXMubG9nJztcclxuXHJcbi8qKlxyXG4gKiBHaXZlbiBhIHJlYWQtb25seSBtb2RlLCBtYWtlcyBpdCB3cml0YWJsZS5cclxuICovXHJcbmZ1bmN0aW9uIG1ha2VNb2RlV3JpdGFibGUobW9kZTogbnVtYmVyKTogbnVtYmVyIHtcclxuICByZXR1cm4gMHg5MiB8IG1vZGU7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBPdmVybGF5cyBhIFJPIGZpbGUgdG8gbWFrZSBpdCB3cml0YWJsZS5cclxuICovXHJcbmNsYXNzIE92ZXJsYXlGaWxlIGV4dGVuZHMgcHJlbG9hZF9maWxlLlByZWxvYWRGaWxlPE92ZXJsYXlGUz4gaW1wbGVtZW50cyBmaWxlLkZpbGUge1xyXG4gIGNvbnN0cnVjdG9yKGZzOiBPdmVybGF5RlMsIHBhdGg6IHN0cmluZywgZmxhZzogRmlsZUZsYWcsIHN0YXRzOiBTdGF0cywgZGF0YTogQnVmZmVyKSB7XHJcbiAgICBzdXBlcihmcywgcGF0aCwgZmxhZywgc3RhdHMsIGRhdGEpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIHN5bmNTeW5jKCk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuaXNEaXJ0eSgpKSB7XHJcbiAgICAgIHRoaXMuX2ZzLl9zeW5jU3luYyh0aGlzKTtcclxuICAgICAgdGhpcy5yZXNldERpcnR5KCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgY2xvc2VTeW5jKCk6IHZvaWQge1xyXG4gICAgdGhpcy5zeW5jU3luYygpO1xyXG4gIH1cclxufVxyXG5cclxuLyoqXHJcbiAqIE92ZXJsYXlGUyBtYWtlcyBhIHJlYWQtb25seSBmaWxlc3lzdGVtIHdyaXRhYmxlIGJ5IHN0b3Jpbmcgd3JpdGVzIG9uIGEgc2Vjb25kLFxyXG4gKiB3cml0YWJsZSBmaWxlIHN5c3RlbS4gRGVsZXRlcyBhcmUgcGVyc2lzdGVkIHZpYSBtZXRhZGF0YSBzdG9yZWQgb24gdGhlIHdyaXRhYmxlXHJcbiAqIGZpbGUgc3lzdGVtLlxyXG4gKlxyXG4gKiBDdXJyZW50bHkgb25seSB3b3JrcyBmb3IgdHdvIHN5bmNocm9ub3VzIGZpbGUgc3lzdGVtcy5cclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIE92ZXJsYXlGUyBleHRlbmRzIGZpbGVfc3lzdGVtLlN5bmNocm9ub3VzRmlsZVN5c3RlbSBpbXBsZW1lbnRzIGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0ge1xyXG4gIHByaXZhdGUgX3dyaXRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtO1xyXG4gIHByaXZhdGUgX3JlYWRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtO1xyXG4gIHByaXZhdGUgX2lzSW5pdGlhbGl6ZWQ6IGJvb2xlYW4gPSBmYWxzZTtcclxuICBwcml2YXRlIF9pbml0aWFsaXplQ2FsbGJhY2tzOiAoKGU/OiBBcGlFcnJvcikgPT4gdm9pZClbXSA9IFtdO1xyXG4gIHByaXZhdGUgX2RlbGV0ZWRGaWxlczoge1twYXRoOiBzdHJpbmddOiBib29sZWFufSA9IHt9O1xyXG4gIHByaXZhdGUgX2RlbGV0ZUxvZzogZmlsZS5GaWxlID0gbnVsbDtcclxuXHJcbiAgY29uc3RydWN0b3Iod3JpdGFibGU6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW0sIHJlYWRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtKSB7XHJcbiAgICBzdXBlcigpO1xyXG4gICAgdGhpcy5fd3JpdGFibGUgPSB3cml0YWJsZTtcclxuICAgIHRoaXMuX3JlYWRhYmxlID0gcmVhZGFibGU7XHJcbiAgICBpZiAodGhpcy5fd3JpdGFibGUuaXNSZWFkT25seSgpKSB7XHJcbiAgICAgIHRocm93IG5ldyBBcGlFcnJvcihFcnJvckNvZGUuRUlOVkFMLCBcIldyaXRhYmxlIGZpbGUgc3lzdGVtIG11c3QgYmUgd3JpdGFibGUuXCIpO1xyXG4gICAgfVxyXG4gICAgaWYgKCF0aGlzLl93cml0YWJsZS5zdXBwb3J0c1N5bmNoKCkgfHwgIXRoaXMuX3JlYWRhYmxlLnN1cHBvcnRzU3luY2goKSkge1xyXG4gICAgICB0aHJvdyBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVJTlZBTCwgXCJPdmVybGF5RlMgY3VycmVudGx5IG9ubHkgb3BlcmF0ZXMgb24gc3luY2hyb25vdXMgZmlsZSBzeXN0ZW1zLlwiKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2hlY2tJbml0aWFsaXplZCgpOiB2b2lkIHtcclxuICAgIGlmICghdGhpcy5faXNJbml0aWFsaXplZCkge1xyXG4gICAgICB0aHJvdyBuZXcgQXBpRXJyb3IoRXJyb3JDb2RlLkVQRVJNLCBcIk92ZXJsYXlGUyBpcyBub3QgaW5pdGlhbGl6ZWQuIFBsZWFzZSBpbml0aWFsaXplIE92ZXJsYXlGUyB1c2luZyBpdHMgaW5pdGlhbGl6ZSgpIG1ldGhvZCBiZWZvcmUgdXNpbmcgaXQuXCIpO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldE92ZXJsYXllZEZpbGVTeXN0ZW1zKCk6IHsgcmVhZGFibGU6IGZpbGVfc3lzdGVtLkZpbGVTeXN0ZW07IHdyaXRhYmxlOiBmaWxlX3N5c3RlbS5GaWxlU3lzdGVtOyB9IHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIHJlYWRhYmxlOiB0aGlzLl9yZWFkYWJsZSxcclxuICAgICAgd3JpdGFibGU6IHRoaXMuX3dyaXRhYmxlXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogV2l0aCB0aGUgZ2l2ZW4gcGF0aCwgY3JlYXRlIHRoZSBuZWVkZWQgcGFyZW50IGRpcmVjdG9yaWVzIG9uIHRoZSB3cml0YWJsZSBzdG9yYWdlXHJcbiAgICogc2hvdWxkIHRoZXkgbm90IGV4aXN0LiBVc2UgbW9kZXMgZnJvbSB0aGUgcmVhZC1vbmx5IHN0b3JhZ2UuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjcmVhdGVQYXJlbnREaXJlY3RvcmllcyhwOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHZhciBwYXJlbnQgPSBwYXRoLmRpcm5hbWUocCksIHRvQ3JlYXRlOiBzdHJpbmdbXSA9IFtdO1xyXG4gICAgd2hpbGUgKCF0aGlzLl93cml0YWJsZS5leGlzdHNTeW5jKHBhcmVudCkpIHtcclxuICAgICAgdG9DcmVhdGUucHVzaChwYXJlbnQpO1xyXG4gICAgICBwYXJlbnQgPSBwYXRoLmRpcm5hbWUocGFyZW50KTtcclxuICAgIH1cclxuICAgIHRvQ3JlYXRlID0gdG9DcmVhdGUucmV2ZXJzZSgpO1xyXG5cclxuICAgIHRvQ3JlYXRlLmZvckVhY2goKHA6IHN0cmluZykgPT4ge1xyXG4gICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMocCwgdGhpcy5zdGF0U3luYyhwLCBmYWxzZSkubW9kZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBzdGF0aWMgaXNBdmFpbGFibGUoKTogYm9vbGVhbiB7XHJcbiAgICByZXR1cm4gdHJ1ZTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBfc3luY1N5bmMoZmlsZTogcHJlbG9hZF9maWxlLlByZWxvYWRGaWxlPGFueT4pOiB2b2lkIHtcclxuICAgIHRoaXMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMoZmlsZS5nZXRQYXRoKCkpO1xyXG4gICAgdGhpcy5fd3JpdGFibGUud3JpdGVGaWxlU3luYyhmaWxlLmdldFBhdGgoKSwgZmlsZS5nZXRCdWZmZXIoKSwgbnVsbCwgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3cnKSwgZmlsZS5nZXRTdGF0cygpLm1vZGUpO1xyXG4gIH1cclxuXHJcbiAgcHVibGljIGdldE5hbWUoKSB7XHJcbiAgICByZXR1cm4gXCJPdmVybGF5RlNcIjtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIENhbGxlZCBvbmNlIHRvIGxvYWQgdXAgbWV0YWRhdGEgc3RvcmVkIG9uIHRoZSB3cml0YWJsZSBmaWxlIHN5c3RlbS5cclxuICAgKi9cclxuICBwdWJsaWMgaW5pdGlhbGl6ZShjYjogKGVycj86IEFwaUVycm9yKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICBjb25zdCBjYWxsYmFja0FycmF5ID0gdGhpcy5faW5pdGlhbGl6ZUNhbGxiYWNrcztcclxuXHJcbiAgICBjb25zdCBlbmQgPSAoZT86IEFwaUVycm9yKTogdm9pZCA9PiB7XHJcbiAgICAgIHRoaXMuX2lzSW5pdGlhbGl6ZWQgPSAhZTtcclxuICAgICAgdGhpcy5faW5pdGlhbGl6ZUNhbGxiYWNrcyA9IFtdO1xyXG4gICAgICBjYWxsYmFja0FycmF5LmZvckVhY2goKChjYikgPT4gY2IoZSkpKTtcclxuICAgIH07XHJcblxyXG4gICAgaWYgKCF0aGlzLl9pc0luaXRpYWxpemVkKSB7XHJcbiAgICAgIC8vIFRoZSBmaXJzdCBjYWxsIHRvIGluaXRpYWxpemUgaW5pdGlhbGl6ZXMsIHRoZSByZXN0IHdhaXQgZm9yIGl0IHRvIGNvbXBsZXRlLlxyXG4gICAgICBpZiAoY2FsbGJhY2tBcnJheS5wdXNoKGNiKSA9PT0gMSkge1xyXG4gICAgICAgIC8vIFJlYWQgZGVsZXRpb24gbG9nLCBwcm9jZXNzIGludG8gbWV0YWRhdGEuXHJcbiAgICAgICAgdGhpcy5fd3JpdGFibGUucmVhZEZpbGUoZGVsZXRpb25Mb2dQYXRoLCAndXRmOCcsXHJcbiAgICAgICAgICBGaWxlRmxhZy5nZXRGaWxlRmxhZygncicpLCAoZXJyOiBBcGlFcnJvciwgZGF0YT86IHN0cmluZykgPT4ge1xyXG4gICAgICAgICAgaWYgKGVycikge1xyXG4gICAgICAgICAgICAvLyBFTk9FTlQgPT09IE5ld2x5LWluc3RhbnRpYXRlZCBmaWxlIHN5c3RlbSwgYW5kIHRodXMgZW1wdHkgbG9nLlxyXG4gICAgICAgICAgICBpZiAoZXJyLmVycm5vICE9PSBFcnJvckNvZGUuRU5PRU5UKSB7XHJcbiAgICAgICAgICAgICAgcmV0dXJuIGVuZChlcnIpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICBkYXRhLnNwbGl0KCdcXG4nKS5mb3JFYWNoKChwYXRoOiBzdHJpbmcpID0+IHtcclxuICAgICAgICAgICAgICAvLyBJZiB0aGUgbG9nIGVudHJ5IGJlZ2lucyB3LyAnZCcsIGl0J3MgYSBkZWxldGlvbi4gT3RoZXJ3aXNlLCBpdCdzXHJcbiAgICAgICAgICAgICAgLy8gYW4gdW5kZWxldGlvbi5cclxuICAgICAgICAgICAgICAvLyBUT0RPOiBDbGVhbiB1cCBsb2cgZHVyaW5nIGluaXRpYWxpemF0aW9uIHBoYXNlLlxyXG4gICAgICAgICAgICAgIHRoaXMuX2RlbGV0ZWRGaWxlc1twYXRoLnNsaWNlKDEpXSA9IHBhdGguc2xpY2UoMCwgMSkgPT09ICdkJztcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgICAvLyBPcGVuIHVwIHRoZSBkZWxldGlvbiBsb2cgZm9yIGFwcGVuZGluZy5cclxuICAgICAgICAgIHRoaXMuX3dyaXRhYmxlLm9wZW4oZGVsZXRpb25Mb2dQYXRoLCBGaWxlRmxhZy5nZXRGaWxlRmxhZygnYScpLFxyXG4gICAgICAgICAgICAweDFhNCwgKGVycjogQXBpRXJyb3IsIGZkPzogZmlsZS5GaWxlKSA9PiB7XHJcbiAgICAgICAgICAgIGlmIChlcnIpIHtcclxuICAgICAgICAgICAgICBlbmQoZXJyKTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICB0aGlzLl9kZWxldGVMb2cgPSBmZDtcclxuICAgICAgICAgICAgICBlbmQoKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGNiKCk7XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwdWJsaWMgaXNSZWFkT25seSgpOiBib29sZWFuIHsgcmV0dXJuIGZhbHNlOyB9XHJcbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7IHJldHVybiB0cnVlOyB9XHJcbiAgcHVibGljIHN1cHBvcnRzTGlua3MoKTogYm9vbGVhbiB7IHJldHVybiBmYWxzZTsgfVxyXG4gIHB1YmxpYyBzdXBwb3J0c1Byb3BzKCk6IGJvb2xlYW4geyByZXR1cm4gdGhpcy5fcmVhZGFibGUuc3VwcG9ydHNQcm9wcygpICYmIHRoaXMuX3dyaXRhYmxlLnN1cHBvcnRzUHJvcHMoKTsgfVxyXG5cclxuICBwcml2YXRlIGRlbGV0ZVBhdGgocDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLl9kZWxldGVkRmlsZXNbcF0gPSB0cnVlO1xyXG4gICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKFwiZFwiICsgcCArIFwiXFxuXCIpO1xyXG4gICAgdGhpcy5fZGVsZXRlTG9nLndyaXRlU3luYyhidWZmLCAwLCBidWZmLmxlbmd0aCwgbnVsbCk7XHJcbiAgICB0aGlzLl9kZWxldGVMb2cuc3luY1N5bmMoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgdW5kZWxldGVQYXRoKHA6IHN0cmluZyk6IHZvaWQge1xyXG4gICAgaWYgKHRoaXMuX2RlbGV0ZWRGaWxlc1twXSkge1xyXG4gICAgICB0aGlzLl9kZWxldGVkRmlsZXNbcF0gPSBmYWxzZTtcclxuICAgICAgdmFyIGJ1ZmYgPSBuZXcgQnVmZmVyKFwidVwiICsgcCk7XHJcbiAgICAgIHRoaXMuX2RlbGV0ZUxvZy53cml0ZVN5bmMoYnVmZiwgMCwgYnVmZi5sZW5ndGgsIG51bGwpO1xyXG4gICAgICB0aGlzLl9kZWxldGVMb2cuc3luY1N5bmMoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHB1YmxpYyByZW5hbWVTeW5jKG9sZFBhdGg6IHN0cmluZywgbmV3UGF0aDogc3RyaW5nKTogdm9pZCB7XHJcbiAgICB0aGlzLmNoZWNrSW5pdGlhbGl6ZWQoKTtcclxuICAgIC8vIFdyaXRlIG5ld1BhdGggdXNpbmcgb2xkUGF0aCdzIGNvbnRlbnRzLCBkZWxldGUgb2xkUGF0aC5cclxuICAgIHZhciBvbGRTdGF0cyA9IHRoaXMuc3RhdFN5bmMob2xkUGF0aCwgZmFsc2UpO1xyXG4gICAgaWYgKG9sZFN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcclxuICAgICAgLy8gT3B0aW1pemF0aW9uOiBEb24ndCBib3RoZXIgbW92aW5nIGlmIG9sZCA9PT0gbmV3LlxyXG4gICAgICBpZiAob2xkUGF0aCA9PT0gbmV3UGF0aCkge1xyXG4gICAgICAgIHJldHVybjtcclxuICAgICAgfVxyXG5cclxuICAgICAgdmFyIG1vZGUgPSAweDFmZjtcclxuICAgICAgaWYgKHRoaXMuZXhpc3RzU3luYyhuZXdQYXRoKSkge1xyXG4gICAgICAgIHZhciBzdGF0cyA9IHRoaXMuc3RhdFN5bmMobmV3UGF0aCwgZmFsc2UpLFxyXG4gICAgICAgICAgbW9kZSA9IHN0YXRzLm1vZGU7XHJcbiAgICAgICAgaWYgKHN0YXRzLmlzRGlyZWN0b3J5KCkpIHtcclxuICAgICAgICAgIGlmICh0aGlzLnJlYWRkaXJTeW5jKG5ld1BhdGgpLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PVEVNUFRZKG5ld1BhdGgpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICB0aHJvdyBBcGlFcnJvci5FTk9URElSKG5ld1BhdGgpO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gVGFrZSBjYXJlIG9mIHdyaXRhYmxlIGZpcnN0LiBNb3ZlIGFueSBmaWxlcyB0aGVyZSwgb3IgY3JlYXRlIGFuIGVtcHR5IGRpcmVjdG9yeVxyXG4gICAgICAvLyBpZiBpdCBkb2Vzbid0IGV4aXN0LlxyXG4gICAgICBpZiAodGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhvbGRQYXRoKSkge1xyXG4gICAgICAgIHRoaXMuX3dyaXRhYmxlLnJlbmFtZVN5bmMob2xkUGF0aCwgbmV3UGF0aCk7XHJcbiAgICAgIH0gZWxzZSBpZiAoIXRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMobmV3UGF0aCkpIHtcclxuICAgICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMobmV3UGF0aCwgbW9kZSk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIE5lZWQgdG8gbW92ZSAqZXZlcnkgZmlsZS9mb2xkZXIqIGN1cnJlbnRseSBzdG9yZWQgb24gcmVhZGFibGUgdG8gaXRzIG5ldyBsb2NhdGlvblxyXG4gICAgICAvLyBvbiB3cml0YWJsZS5cclxuICAgICAgaWYgKHRoaXMuX3JlYWRhYmxlLmV4aXN0c1N5bmMob2xkUGF0aCkpIHtcclxuICAgICAgICB0aGlzLl9yZWFkYWJsZS5yZWFkZGlyU3luYyhvbGRQYXRoKS5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgICAvLyBSZWN1cnNpb24hIFNob3VsZCB3b3JrIGZvciBhbnkgbmVzdGVkIGZpbGVzIC8gZm9sZGVycy5cclxuICAgICAgICAgIHRoaXMucmVuYW1lU3luYyhwYXRoLnJlc29sdmUob2xkUGF0aCwgbmFtZSksIHBhdGgucmVzb2x2ZShuZXdQYXRoLCBuYW1lKSk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIGlmICh0aGlzLmV4aXN0c1N5bmMobmV3UGF0aCkgJiYgdGhpcy5zdGF0U3luYyhuZXdQYXRoLCBmYWxzZSkuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICAgIHRocm93IEFwaUVycm9yLkVJU0RJUihuZXdQYXRoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgdGhpcy53cml0ZUZpbGVTeW5jKG5ld1BhdGgsXHJcbiAgICAgICAgdGhpcy5yZWFkRmlsZVN5bmMob2xkUGF0aCwgbnVsbCwgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3InKSksIG51bGwsXHJcbiAgICAgICAgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3cnKSwgb2xkU3RhdHMubW9kZSk7XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKG9sZFBhdGggIT09IG5ld1BhdGggJiYgdGhpcy5leGlzdHNTeW5jKG9sZFBhdGgpKSB7XHJcbiAgICAgIHRoaXMudW5saW5rU3luYyhvbGRQYXRoKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIHN0YXRTeW5jKHA6IHN0cmluZywgaXNMc3RhdDogYm9vbGVhbik6IFN0YXRzIHtcclxuICAgIHRoaXMuY2hlY2tJbml0aWFsaXplZCgpO1xyXG4gICAgdHJ5IHtcclxuICAgICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlLnN0YXRTeW5jKHAsIGlzTHN0YXQpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgICBpZiAodGhpcy5fZGVsZXRlZEZpbGVzW3BdKSB7XHJcbiAgICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHApO1xyXG4gICAgICB9XHJcbiAgICAgIHZhciBvbGRTdGF0ID0gdGhpcy5fcmVhZGFibGUuc3RhdFN5bmMocCwgaXNMc3RhdCkuY2xvbmUoKTtcclxuICAgICAgLy8gTWFrZSB0aGUgb2xkU3RhdCdzIG1vZGUgd3JpdGFibGUuIFByZXNlcnZlIHRoZSB0b3Btb3N0IHBhcnQgb2YgdGhlXHJcbiAgICAgIC8vIG1vZGUsIHdoaWNoIHNwZWNpZmllcyBpZiBpdCBpcyBhIGZpbGUgb3IgYSBkaXJlY3RvcnkuXHJcbiAgICAgIG9sZFN0YXQubW9kZSA9IG1ha2VNb2RlV3JpdGFibGUob2xkU3RhdC5tb2RlKTtcclxuICAgICAgcmV0dXJuIG9sZFN0YXQ7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHB1YmxpYyBvcGVuU3luYyhwOiBzdHJpbmcsIGZsYWc6IEZpbGVGbGFnLCBtb2RlOiBudW1iZXIpOiBmaWxlLkZpbGUge1xyXG4gICAgdGhpcy5jaGVja0luaXRpYWxpemVkKCk7XHJcbiAgICBpZiAodGhpcy5leGlzdHNTeW5jKHApKSB7XHJcbiAgICAgIHN3aXRjaCAoZmxhZy5wYXRoRXhpc3RzQWN0aW9uKCkpIHtcclxuICAgICAgICBjYXNlIEFjdGlvblR5cGUuVFJVTkNBVEVfRklMRTpcclxuICAgICAgICAgIHRoaXMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMocCk7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGUub3BlblN5bmMocCwgZmxhZywgbW9kZSk7XHJcbiAgICAgICAgY2FzZSBBY3Rpb25UeXBlLk5PUDpcclxuICAgICAgICAgIGlmICh0aGlzLl93cml0YWJsZS5leGlzdHNTeW5jKHApKSB7XHJcbiAgICAgICAgICAgIHJldHVybiB0aGlzLl93cml0YWJsZS5vcGVuU3luYyhwLCBmbGFnLCBtb2RlKTtcclxuICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgIC8vIENyZWF0ZSBhbiBPdmVybGF5RmlsZS5cclxuICAgICAgICAgICAgdmFyIHN0YXRzID0gdGhpcy5fcmVhZGFibGUuc3RhdFN5bmMocCwgZmFsc2UpLmNsb25lKCk7XHJcbiAgICAgICAgICAgIHN0YXRzLm1vZGUgPSBtb2RlO1xyXG4gICAgICAgICAgICByZXR1cm4gbmV3IE92ZXJsYXlGaWxlKHRoaXMsIHAsIGZsYWcsIHN0YXRzLCB0aGlzLl9yZWFkYWJsZS5yZWFkRmlsZVN5bmMocCwgbnVsbCwgRmlsZUZsYWcuZ2V0RmlsZUZsYWcoJ3InKSkpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgIGRlZmF1bHQ6XHJcbiAgICAgICAgICB0aHJvdyBBcGlFcnJvci5FRVhJU1QocCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHN3aXRjaChmbGFnLnBhdGhOb3RFeGlzdHNBY3Rpb24oKSkge1xyXG4gICAgICAgIGNhc2UgQWN0aW9uVHlwZS5DUkVBVEVfRklMRTpcclxuICAgICAgICAgIHRoaXMuY3JlYXRlUGFyZW50RGlyZWN0b3JpZXMocCk7XHJcbiAgICAgICAgICByZXR1cm4gdGhpcy5fd3JpdGFibGUub3BlblN5bmMocCwgZmxhZywgbW9kZSk7XHJcbiAgICAgICAgZGVmYXVsdDpcclxuICAgICAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwKTtcclxuICAgICAgfVxyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgdW5saW5rU3luYyhwOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tJbml0aWFsaXplZCgpO1xyXG4gICAgaWYgKHRoaXMuZXhpc3RzU3luYyhwKSkge1xyXG4gICAgICBpZiAodGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwKSkge1xyXG4gICAgICAgIHRoaXMuX3dyaXRhYmxlLnVubGlua1N5bmMocCk7XHJcbiAgICAgIH1cclxuXHJcbiAgICAgIC8vIERvZXMgaXQgc3RpbGwgZXhpc3Q/XHJcbiAgICAgIGlmICh0aGlzLmV4aXN0c1N5bmMocCkpIHtcclxuICAgICAgICAvLyBBZGQgdG8gZGVsZXRlIGxvZy5cclxuICAgICAgICB0aGlzLmRlbGV0ZVBhdGgocCk7XHJcbiAgICAgIH1cclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT0VOVChwKTtcclxuICAgIH1cclxuICB9XHJcbiAgcHVibGljIHJtZGlyU3luYyhwOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tJbml0aWFsaXplZCgpO1xyXG4gICAgaWYgKHRoaXMuZXhpc3RzU3luYyhwKSkge1xyXG4gICAgICBpZiAodGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwKSkge1xyXG4gICAgICAgIHRoaXMuX3dyaXRhYmxlLnJtZGlyU3luYyhwKTtcclxuICAgICAgfVxyXG4gICAgICBpZiAodGhpcy5leGlzdHNTeW5jKHApKSB7XHJcbiAgICAgICAgLy8gQ2hlY2sgaWYgZGlyZWN0b3J5IGlzIGVtcHR5LlxyXG4gICAgICAgIGlmICh0aGlzLnJlYWRkaXJTeW5jKHApLmxlbmd0aCA+IDApIHtcclxuICAgICAgICAgIHRocm93IEFwaUVycm9yLkVOT1RFTVBUWShwKTtcclxuICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgdGhpcy5kZWxldGVQYXRoKHApO1xyXG4gICAgICAgIH1cclxuICAgICAgfVxyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHApO1xyXG4gICAgfVxyXG4gIH1cclxuICBwdWJsaWMgbWtkaXJTeW5jKHA6IHN0cmluZywgbW9kZTogbnVtYmVyKTogdm9pZCB7XHJcbiAgICB0aGlzLmNoZWNrSW5pdGlhbGl6ZWQoKTtcclxuICAgIGlmICh0aGlzLmV4aXN0c1N5bmMocCkpIHtcclxuICAgICAgdGhyb3cgQXBpRXJyb3IuRUVYSVNUKHApO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gVGhlIGJlbG93IHdpbGwgdGhyb3cgc2hvdWxkIGFueSBvZiB0aGUgcGFyZW50IGRpcmVjdG9yaWVzIGZhaWwgdG8gZXhpc3RcclxuICAgICAgLy8gb24gX3dyaXRhYmxlLlxyXG4gICAgICB0aGlzLmNyZWF0ZVBhcmVudERpcmVjdG9yaWVzKHApO1xyXG4gICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMocCwgbW9kZSk7XHJcbiAgICB9XHJcbiAgfVxyXG4gIHB1YmxpYyByZWFkZGlyU3luYyhwOiBzdHJpbmcpOiBzdHJpbmdbXSB7XHJcbiAgICB0aGlzLmNoZWNrSW5pdGlhbGl6ZWQoKTtcclxuICAgIHZhciBkaXJTdGF0cyA9IHRoaXMuc3RhdFN5bmMocCwgZmFsc2UpO1xyXG4gICAgaWYgKCFkaXJTdGF0cy5pc0RpcmVjdG9yeSgpKSB7XHJcbiAgICAgIHRocm93IEFwaUVycm9yLkVOT1RESVIocCk7XHJcbiAgICB9XHJcblxyXG4gICAgLy8gUmVhZGRpciBpbiBib3RoLCBtZXJnZSwgY2hlY2sgZGVsZXRlIGxvZyBvbiBlYWNoIGZpbGUsIHJldHVybi5cclxuICAgIHZhciBjb250ZW50czogc3RyaW5nW10gPSBbXTtcclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnRlbnRzID0gY29udGVudHMuY29uY2F0KHRoaXMuX3dyaXRhYmxlLnJlYWRkaXJTeW5jKHApKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgIH1cclxuICAgIHRyeSB7XHJcbiAgICAgIGNvbnRlbnRzID0gY29udGVudHMuY29uY2F0KHRoaXMuX3JlYWRhYmxlLnJlYWRkaXJTeW5jKHApKTtcclxuICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgIH1cclxuICAgIHZhciBzZWVuTWFwOiB7W25hbWU6IHN0cmluZ106IGJvb2xlYW59ID0ge307XHJcbiAgICByZXR1cm4gY29udGVudHMuZmlsdGVyKChmaWxlUDogc3RyaW5nKSA9PiB7XHJcbiAgICAgIHZhciByZXN1bHQgPSBzZWVuTWFwW2ZpbGVQXSA9PT0gdW5kZWZpbmVkICYmIHRoaXMuX2RlbGV0ZWRGaWxlc1twICsgXCIvXCIgKyBmaWxlUF0gIT09IHRydWU7XHJcbiAgICAgIHNlZW5NYXBbZmlsZVBdID0gdHJ1ZTtcclxuICAgICAgcmV0dXJuIHJlc3VsdDtcclxuICAgIH0pO1xyXG4gIH1cclxuICBwdWJsaWMgZXhpc3RzU3luYyhwOiBzdHJpbmcpOiBib29sZWFuIHtcclxuICAgIHRoaXMuY2hlY2tJbml0aWFsaXplZCgpO1xyXG4gICAgcmV0dXJuIHRoaXMuX3dyaXRhYmxlLmV4aXN0c1N5bmMocCkgfHwgKHRoaXMuX3JlYWRhYmxlLmV4aXN0c1N5bmMocCkgJiYgdGhpcy5fZGVsZXRlZEZpbGVzW3BdICE9PSB0cnVlKTtcclxuICB9XHJcbiAgcHVibGljIGNobW9kU3luYyhwOiBzdHJpbmcsIGlzTGNobW9kOiBib29sZWFuLCBtb2RlOiBudW1iZXIpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tJbml0aWFsaXplZCgpO1xyXG4gICAgdGhpcy5vcGVyYXRlT25Xcml0YWJsZShwLCAoKSA9PiB7XHJcbiAgICAgIHRoaXMuX3dyaXRhYmxlLmNobW9kU3luYyhwLCBpc0xjaG1vZCwgbW9kZSk7XHJcbiAgICB9KTtcclxuICB9XHJcbiAgcHVibGljIGNob3duU3luYyhwOiBzdHJpbmcsIGlzTGNob3duOiBib29sZWFuLCB1aWQ6IG51bWJlciwgZ2lkOiBudW1iZXIpOiB2b2lkIHtcclxuICAgIHRoaXMuY2hlY2tJbml0aWFsaXplZCgpO1xyXG4gICAgdGhpcy5vcGVyYXRlT25Xcml0YWJsZShwLCAoKSA9PiB7XHJcbiAgICAgIHRoaXMuX3dyaXRhYmxlLmNob3duU3luYyhwLCBpc0xjaG93biwgdWlkLCBnaWQpO1xyXG4gICAgfSk7XHJcbiAgfVxyXG4gIHB1YmxpYyB1dGltZXNTeW5jKHA6IHN0cmluZywgYXRpbWU6IERhdGUsIG10aW1lOiBEYXRlKTogdm9pZCB7XHJcbiAgICB0aGlzLmNoZWNrSW5pdGlhbGl6ZWQoKTtcclxuICAgIHRoaXMub3BlcmF0ZU9uV3JpdGFibGUocCwgKCkgPT4ge1xyXG4gICAgICB0aGlzLl93cml0YWJsZS51dGltZXNTeW5jKHAsIGF0aW1lLCBtdGltZSk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEhlbHBlciBmdW5jdGlvbjpcclxuICAgKiAtIEVuc3VyZXMgcCBpcyBvbiB3cml0YWJsZSBiZWZvcmUgcHJvY2VlZGluZy4gVGhyb3dzIGFuIGVycm9yIGlmIGl0IGRvZXNuJ3QgZXhpc3QuXHJcbiAgICogLSBDYWxscyBmIHRvIHBlcmZvcm0gb3BlcmF0aW9uIG9uIHdyaXRhYmxlLlxyXG4gICAqL1xyXG4gIHByaXZhdGUgb3BlcmF0ZU9uV3JpdGFibGUocDogc3RyaW5nLCBmOiAoKSA9PiB2b2lkKTogdm9pZCB7XHJcbiAgICBpZiAodGhpcy5leGlzdHNTeW5jKHApKSB7XHJcbiAgICAgIGlmICghdGhpcy5fd3JpdGFibGUuZXhpc3RzU3luYyhwKSkge1xyXG4gICAgICAgIC8vIEZpbGUgaXMgb24gcmVhZGFibGUgc3RvcmFnZS4gQ29weSB0byB3cml0YWJsZSBzdG9yYWdlIGJlZm9yZVxyXG4gICAgICAgIC8vIGNoYW5naW5nIGl0cyBtb2RlLlxyXG4gICAgICAgIHRoaXMuY29weVRvV3JpdGFibGUocCk7XHJcbiAgICAgIH1cclxuICAgICAgZigpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhyb3cgQXBpRXJyb3IuRU5PRU5UKHApO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQ29weSBmcm9tIHJlYWRhYmxlIHRvIHdyaXRhYmxlIHN0b3JhZ2UuXHJcbiAgICogUFJFQ09ORElUSU9OOiBGaWxlIGRvZXMgbm90IGV4aXN0IG9uIHdyaXRhYmxlIHN0b3JhZ2UuXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBjb3B5VG9Xcml0YWJsZShwOiBzdHJpbmcpOiB2b2lkIHtcclxuICAgIHZhciBwU3RhdHMgPSB0aGlzLnN0YXRTeW5jKHAsIGZhbHNlKTtcclxuICAgIGlmIChwU3RhdHMuaXNEaXJlY3RvcnkoKSkge1xyXG4gICAgICB0aGlzLl93cml0YWJsZS5ta2RpclN5bmMocCwgcFN0YXRzLm1vZGUpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy53cml0ZUZpbGVTeW5jKHAsXHJcbiAgICAgICAgdGhpcy5fcmVhZGFibGUucmVhZEZpbGVTeW5jKHAsIG51bGwsIEZpbGVGbGFnLmdldEZpbGVGbGFnKCdyJykpLCBudWxsLFxyXG4gICAgICAgIEZpbGVGbGFnLmdldEZpbGVGbGFnKCd3JyksIHRoaXMuc3RhdFN5bmMocCwgZmFsc2UpLm1vZGUpO1xyXG4gICAgfVxyXG4gIH1cclxufVxyXG4iXX0=