"use strict";
var __extends = (this && this.__extends) || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
    function __() { this.constructor = d; }
    d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
};
var file_system_1 = require('../core/file_system');
var path = require('path');
var api_error_1 = require('../core/api_error');
var FolderAdapter = (function (_super) {
    __extends(FolderAdapter, _super);
    function FolderAdapter(folder, wrapped) {
        _super.call(this);
        this._folder = folder;
        this._wrapped = wrapped;
    }
    FolderAdapter.prototype.initialize = function (cb) {
        var _this = this;
        this._wrapped.exists(this._folder, function (exists) {
            if (exists) {
                cb();
            }
            else if (_this._wrapped.isReadOnly()) {
                cb(api_error_1.ApiError.ENOENT(_this._folder));
            }
            else {
                _this._wrapped.mkdir(_this._folder, 0x1ff, cb);
            }
        });
    };
    FolderAdapter.prototype.getName = function () { return this._wrapped.getName(); };
    FolderAdapter.prototype.isReadOnly = function () { return this._wrapped.isReadOnly(); };
    FolderAdapter.prototype.supportsProps = function () { return this._wrapped.supportsProps(); };
    FolderAdapter.prototype.supportsSynch = function () { return this._wrapped.supportsSynch(); };
    FolderAdapter.prototype.supportsLinks = function () { return false; };
    FolderAdapter.isAvailable = function () {
        return true;
    };
    return FolderAdapter;
}(file_system_1.BaseFileSystem));
exports.__esModule = true;
exports["default"] = FolderAdapter;
function translateError(folder, e) {
    if (e !== null && typeof e === 'object') {
        var err = e;
        var p = err.path;
        if (p) {
            p = '/' + path.relative(folder, p);
            err.message = err.message.replace(err.path, p);
            err.path = p;
        }
    }
    return e;
}
function wrapCallback(folder, cb) {
    if (typeof cb === 'function') {
        return function (err) {
            if (arguments.length > 0) {
                arguments[0] = translateError(folder, err);
            }
            cb.apply(null, arguments);
        };
    }
    else {
        return cb;
    }
}
function wrapFunction(name, wrapFirst, wrapSecond) {
    if (name.slice(name.length - 4) !== 'Sync') {
        return function () {
            if (arguments.length > 0) {
                if (wrapFirst) {
                    arguments[0] = path.join(this._folder, arguments[0]);
                }
                if (wrapSecond) {
                    arguments[1] = path.join(this._folder, arguments[1]);
                }
                arguments[arguments.length - 1] = wrapCallback(this._folder, arguments[arguments.length - 1]);
            }
            return this._wrapped[name].apply(this._wrapped, arguments);
        };
    }
    else {
        return function () {
            try {
                if (wrapFirst) {
                    arguments[0] = path.join(this._folder, arguments[0]);
                }
                if (wrapSecond) {
                    arguments[1] = path.join(this._folder, arguments[1]);
                }
                return this._wrapped[name].apply(this._wrapped, arguments);
            }
            catch (e) {
                throw translateError(this._folder, e);
            }
        };
    }
}
['diskSpace', 'stat', 'statSync', 'open', 'openSync', 'unlink', 'unlinkSync',
    'rmdir', 'rmdirSync', 'mkdir', 'mkdirSync', 'readdir', 'readdirSync', 'exists',
    'existsSync', 'realpath', 'realpathSync', 'truncate', 'truncateSync', 'readFile',
    'readFileSync', 'writeFile', 'writeFileSync', 'appendFile', 'appendFileSync',
    'chmod', 'chmodSync', 'chown', 'chownSync', 'utimes', 'utimeSync', 'readlink',
    'readlinkSync'].forEach(function (name) {
    FolderAdapter.prototype[name] = wrapFunction(name, true, false);
});
['rename', 'renameSync', 'link', 'linkSync', 'symlink', 'symlinkSync'].forEach(function (name) {
    FolderAdapter.prototype[name] = wrapFunction(name, true, true);
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRm9sZGVyQWRhcHRlci5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9iYWNrZW5kL0ZvbGRlckFkYXB0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQUEsNEJBQXlDLHFCQUFxQixDQUFDLENBQUE7QUFDL0QsSUFBTyxJQUFJLFdBQVcsTUFBTSxDQUFDLENBQUM7QUFDOUIsMEJBQXVCLG1CQUFtQixDQUFDLENBQUE7QUFLM0M7SUFBMkMsaUNBQWM7SUFHdkQsdUJBQVksTUFBYyxFQUFFLE9BQW1CO1FBQzdDLGlCQUFPLENBQUM7UUFDUixJQUFJLENBQUMsT0FBTyxHQUFHLE1BQU0sQ0FBQztRQUN0QixJQUFJLENBQUMsUUFBUSxHQUFHLE9BQU8sQ0FBQztJQUMxQixDQUFDO0lBTU0sa0NBQVUsR0FBakIsVUFBa0IsRUFBMEI7UUFBNUMsaUJBVUM7UUFUQyxJQUFJLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsT0FBTyxFQUFFLFVBQUMsTUFBZTtZQUNqRCxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDO2dCQUNYLEVBQUUsRUFBRSxDQUFDO1lBQ1AsQ0FBQztZQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFJLENBQUMsUUFBUSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztnQkFDdEMsRUFBRSxDQUFDLG9CQUFRLENBQUMsTUFBTSxDQUFDLEtBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLENBQUM7WUFBQyxJQUFJLENBQUMsQ0FBQztnQkFDTixLQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxLQUFJLENBQUMsT0FBTyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQztZQUMvQyxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRU0sK0JBQU8sR0FBZCxjQUEyQixNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FB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RSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsUUFBUSxFQUFFLFlBQVk7SUFDM0UsT0FBTyxFQUFFLFdBQVcsRUFBRSxPQUFPLEVBQUUsV0FBVyxFQUFFLFNBQVMsRUFBRSxhQUFhLEVBQUUsUUFBUTtJQUM5RSxZQUFZLEVBQUUsVUFBVSxFQUFFLGNBQWMsRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFFLFVBQVU7SUFDaEYsY0FBYyxFQUFFLFdBQVcsRUFBRSxlQUFlLEVBQUUsWUFBWSxFQUFFLGdCQUFnQjtJQUM1RSxPQUFPLEVBQUUsV0FBVyxFQUFFLE9BQU8sRUFBRSxXQUFXLEVBQUUsUUFBUSxFQUFFLFdBQVcsRUFBRSxVQUFVO0lBQzdFLGNBQWMsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxVQUFDLElBQVk7SUFDcEMsYUFBYSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxZQUFZLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsQ0FBQztBQUNsRSxDQUFDLENBQUMsQ0FBQztBQUdILENBQUMsUUFBUSxFQUFFLFlBQVksRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLFNBQVMsRUFBRSxhQUFhLENBQUMsQ0FBQyxPQUFPLENBQUMsVUFBQyxJQUFZO0lBQzFGLGFBQWEsQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLEdBQUcsWUFBWSxDQUFDLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxDQUFDLENBQUM7QUFDakUsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0Jhc2VGaWxlU3lzdGVtLCBGaWxlU3lzdGVtfSBmcm9tICcuLi9jb3JlL2ZpbGVfc3lzdGVtJztcclxuaW1wb3J0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XHJcbmltcG9ydCB7QXBpRXJyb3J9IGZyb20gJy4uL2NvcmUvYXBpX2Vycm9yJztcclxuXHJcbi8qKlxyXG4gKiBUaGUgRm9sZGVyQWRhcHRlciBmaWxlIHN5c3RlbSB3cmFwcyBhIGZpbGUgc3lzdGVtLCBhbmQgc2NvcGVzIGFsbCBpbnRlcmFjdGlvbnMgdG8gYSBzdWJmb2xkZXIgb2YgdGhhdCBmaWxlIHN5c3RlbS5cclxuICovXHJcbmV4cG9ydCBkZWZhdWx0IGNsYXNzIEZvbGRlckFkYXB0ZXIgZXh0ZW5kcyBCYXNlRmlsZVN5c3RlbSBpbXBsZW1lbnRzIEZpbGVTeXN0ZW0ge1xyXG4gIHByaXZhdGUgX3dyYXBwZWQ6IEZpbGVTeXN0ZW07XHJcbiAgcHJpdmF0ZSBfZm9sZGVyOiBzdHJpbmc7XHJcbiAgY29uc3RydWN0b3IoZm9sZGVyOiBzdHJpbmcsIHdyYXBwZWQ6IEZpbGVTeXN0ZW0pIHtcclxuICAgIHN1cGVyKCk7XHJcbiAgICB0aGlzLl9mb2xkZXIgPSBmb2xkZXI7XHJcbiAgICB0aGlzLl93cmFwcGVkID0gd3JhcHBlZDtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEluaXRpYWxpemUgdGhlIGZpbGUgc3lzdGVtLiBFbnN1cmVzIHRoYXQgdGhlIHdyYXBwZWQgZmlsZSBzeXN0ZW1cclxuICAgKiBoYXMgdGhlIGdpdmVuIGZvbGRlci5cclxuICAgKi9cclxuICBwdWJsaWMgaW5pdGlhbGl6ZShjYjogKGU/OiBBcGlFcnJvcikgPT4gdm9pZCkge1xyXG4gICAgdGhpcy5fd3JhcHBlZC5leGlzdHModGhpcy5fZm9sZGVyLCAoZXhpc3RzOiBib29sZWFuKSA9PiB7XHJcbiAgICAgIGlmIChleGlzdHMpIHtcclxuICAgICAgICBjYigpO1xyXG4gICAgICB9IGVsc2UgaWYgKHRoaXMuX3dyYXBwZWQuaXNSZWFkT25seSgpKSB7XHJcbiAgICAgICAgY2IoQXBpRXJyb3IuRU5PRU5UKHRoaXMuX2ZvbGRlcikpO1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHRoaXMuX3dyYXBwZWQubWtkaXIodGhpcy5fZm9sZGVyLCAweDFmZiwgY2IpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHB1YmxpYyBnZXROYW1lKCk6IHN0cmluZyB7IHJldHVybiB0aGlzLl93cmFwcGVkLmdldE5hbWUoKTsgfVxyXG4gIHB1YmxpYyBpc1JlYWRPbmx5KCk6IGJvb2xlYW4geyByZXR1cm4gdGhpcy5fd3JhcHBlZC5pc1JlYWRPbmx5KCk7IH1cclxuICBwdWJsaWMgc3VwcG9ydHNQcm9wcygpOiBib29sZWFuIHsgcmV0dXJuIHRoaXMuX3dyYXBwZWQuc3VwcG9ydHNQcm9wcygpOyB9XHJcbiAgcHVibGljIHN1cHBvcnRzU3luY2goKTogYm9vbGVhbiB7IHJldHVybiB0aGlzLl93cmFwcGVkLnN1cHBvcnRzU3luY2goKTsgfVxyXG4gIHB1YmxpYyBzdXBwb3J0c0xpbmtzKCk6IGJvb2xlYW4geyByZXR1cm4gZmFsc2U7IH1cclxuXHJcbiAgcHVibGljIHN0YXRpYyBpc0F2YWlsYWJsZSgpOiBib29sZWFuIHtcclxuICAgIHJldHVybiB0cnVlO1xyXG4gIH1cclxufVxyXG5cclxuZnVuY3Rpb24gdHJhbnNsYXRlRXJyb3IoZm9sZGVyOiBzdHJpbmcsIGU6IGFueSk6IGFueSB7XHJcbiAgaWYgKGUgIT09IG51bGwgJiYgdHlwZW9mIGUgPT09ICdvYmplY3QnKSB7XHJcbiAgICBsZXQgZXJyID0gPEFwaUVycm9yPiBlO1xyXG4gICAgbGV0IHAgPSBlcnIucGF0aDtcclxuICAgIGlmIChwKSB7XHJcbiAgICAgIHAgPSAnLycgKyBwYXRoLnJlbGF0aXZlKGZvbGRlciwgcCk7XHJcbiAgICAgIGVyci5tZXNzYWdlID0gZXJyLm1lc3NhZ2UucmVwbGFjZShlcnIucGF0aCwgcCk7XHJcbiAgICAgIGVyci5wYXRoID0gcDtcclxuICAgIH1cclxuICB9XHJcbiAgcmV0dXJuIGU7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHdyYXBDYWxsYmFjayhmb2xkZXI6IHN0cmluZywgY2I6IGFueSk6IGFueSB7XHJcbiAgaWYgKHR5cGVvZiBjYiA9PT0gJ2Z1bmN0aW9uJykge1xyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKGVycikge1xyXG4gICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBhcmd1bWVudHNbMF0gPSB0cmFuc2xhdGVFcnJvcihmb2xkZXIsIGVycik7XHJcbiAgICAgIH1cclxuICAgICAgKDxGdW5jdGlvbj4gY2IpLmFwcGx5KG51bGwsIGFyZ3VtZW50cyk7XHJcbiAgICB9O1xyXG4gIH0gZWxzZSB7XHJcbiAgICByZXR1cm4gY2I7XHJcbiAgfVxyXG59XHJcblxyXG5mdW5jdGlvbiB3cmFwRnVuY3Rpb24obmFtZTogc3RyaW5nLCB3cmFwRmlyc3Q6IGJvb2xlYW4sIHdyYXBTZWNvbmQ6IGJvb2xlYW4pOiBGdW5jdGlvbiB7XHJcbiAgaWYgKG5hbWUuc2xpY2UobmFtZS5sZW5ndGggLSA0KSAhPT0gJ1N5bmMnKSB7XHJcbiAgICAvLyBBc3luYyBmdW5jdGlvbi4gVHJhbnNsYXRlIGVycm9yIGluIGNhbGxiYWNrLlxyXG4gICAgcmV0dXJuIGZ1bmN0aW9uKCkge1xyXG4gICAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA+IDApIHtcclxuICAgICAgICBpZiAod3JhcEZpcnN0KSB7XHJcbiAgICAgICAgICBhcmd1bWVudHNbMF0gPSBwYXRoLmpvaW4odGhpcy5fZm9sZGVyLCBhcmd1bWVudHNbMF0pO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAod3JhcFNlY29uZCkge1xyXG4gICAgICAgICAgYXJndW1lbnRzWzFdID0gcGF0aC5qb2luKHRoaXMuX2ZvbGRlciwgYXJndW1lbnRzWzFdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgYXJndW1lbnRzW2FyZ3VtZW50cy5sZW5ndGggLSAxXSA9IHdyYXBDYWxsYmFjayh0aGlzLl9mb2xkZXIsIGFyZ3VtZW50c1thcmd1bWVudHMubGVuZ3RoIC0gMV0pO1xyXG4gICAgICB9XHJcbiAgICAgIHJldHVybiB0aGlzLl93cmFwcGVkW25hbWVdLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cyk7XHJcbiAgICB9O1xyXG4gIH0gZWxzZSB7XHJcbiAgICAvLyBTeW5jIGZ1bmN0aW9uLiBUcmFuc2xhdGUgZXJyb3IgaW4gY2F0Y2guXHJcbiAgICByZXR1cm4gZnVuY3Rpb24oKSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgaWYgKHdyYXBGaXJzdCkge1xyXG4gICAgICAgICAgYXJndW1lbnRzWzBdID0gcGF0aC5qb2luKHRoaXMuX2ZvbGRlciwgYXJndW1lbnRzWzBdKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKHdyYXBTZWNvbmQpIHtcclxuICAgICAgICAgIGFyZ3VtZW50c1sxXSA9IHBhdGguam9pbih0aGlzLl9mb2xkZXIsIGFyZ3VtZW50c1sxXSk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIHJldHVybiB0aGlzLl93cmFwcGVkW25hbWVdLmFwcGx5KHRoaXMuX3dyYXBwZWQsIGFyZ3VtZW50cyk7XHJcbiAgICAgIH0gY2F0Y2ggKGUpIHtcclxuICAgICAgICB0aHJvdyB0cmFuc2xhdGVFcnJvcih0aGlzLl9mb2xkZXIsIGUpO1xyXG4gICAgICB9XHJcbiAgICB9O1xyXG4gIH1cclxufVxyXG5cclxuLy8gRmlyc3QgYXJndW1lbnQgaXMgYSBwYXRoLlxyXG5bJ2Rpc2tTcGFjZScsICdzdGF0JywgJ3N0YXRTeW5jJywgJ29wZW4nLCAnb3BlblN5bmMnLCAndW5saW5rJywgJ3VubGlua1N5bmMnLFxyXG4gJ3JtZGlyJywgJ3JtZGlyU3luYycgLCdta2RpcicsICdta2RpclN5bmMnLCAncmVhZGRpcicsICdyZWFkZGlyU3luYycsICdleGlzdHMnLFxyXG4gJ2V4aXN0c1N5bmMnLCAncmVhbHBhdGgnLCAncmVhbHBhdGhTeW5jJywgJ3RydW5jYXRlJywgJ3RydW5jYXRlU3luYycsICdyZWFkRmlsZScsXHJcbiAncmVhZEZpbGVTeW5jJywgJ3dyaXRlRmlsZScsICd3cml0ZUZpbGVTeW5jJywgJ2FwcGVuZEZpbGUnLCAnYXBwZW5kRmlsZVN5bmMnLFxyXG4gJ2NobW9kJywgJ2NobW9kU3luYycsICdjaG93bicsICdjaG93blN5bmMnLCAndXRpbWVzJywgJ3V0aW1lU3luYycsICdyZWFkbGluaycsXHJcbiAncmVhZGxpbmtTeW5jJ10uZm9yRWFjaCgobmFtZTogc3RyaW5nKSA9PiB7XHJcbiAgRm9sZGVyQWRhcHRlci5wcm90b3R5cGVbbmFtZV0gPSB3cmFwRnVuY3Rpb24obmFtZSwgdHJ1ZSwgZmFsc2UpO1xyXG59KTtcclxuXHJcbi8vIEZpcnN0IGFuZCBzZWNvbmQgYXJndW1lbnRzIGFyZSBwYXRocy5cclxuWydyZW5hbWUnLCAncmVuYW1lU3luYycsICdsaW5rJywgJ2xpbmtTeW5jJywgJ3N5bWxpbmsnLCAnc3ltbGlua1N5bmMnXS5mb3JFYWNoKChuYW1lOiBzdHJpbmcpID0+IHtcclxuICBGb2xkZXJBZGFwdGVyLnByb3RvdHlwZVtuYW1lXSA9IHdyYXBGdW5jdGlvbihuYW1lLCB0cnVlLCB0cnVlKTtcclxufSk7XHJcbiJdfQ==